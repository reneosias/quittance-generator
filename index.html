<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Quittances de Loyer</title>
    <!-- Importation de Tailwind CSS pour le style --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioth√®que pour la g√©n√©ration de PDF --><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Google Fonts: Inter pour le corps de texte, Poppins pour les titres --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles personnalis√©s */
        body {
            font-family: 'Inter', sans-serif;
            color: #333;
        }
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
        }
        .active-tab {
            border-color: #2563EB !important; /* Blue 600 */
            color: #2563EB !important;
            font-weight: 600;
        }
        .inactive-tab {
            border-color: transparent !important;
            color: #6B7280 !important; /* Gray 500 */
        }
        .tab-content.inactive-content {
            display: none;
        }
        .tab-content.active-content {
            display: block;
        }
        
        /* Styles pour l'impression de la quittance (modale) */
        /* Note: Ces styles s'appliquent √† #receipt-print-area uniquement pour l'aper√ßu et l'impression/PDF */
        #receipt-print-area {
            background-color: #ffffff;
            font-family: 'Inter', sans-serif;
            color: #333;
            line-height: 1.6;
            padding: 30px; /* Base padding */
            box-sizing: border-box; /* Important for width calculations */
            position: relative;
            overflow: hidden; /* Ensure background patterns don't overflow */
            /* Ajout d'une image de fond l√©g√®re */
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cLMzYzMC81MDAwLzIwMDAiPgo8cGF0aCBmaWxsPSIjZjhmOGY4IiBmaWxsLW9wYWNpdHk9IjAuNSIgZD0iTSAwIDMwIEwgNTAgMzAgTCA1MCA1MCBMIDAgNTAgeiIgLz4KPC9zdmc+');
            background-repeat: repeat;
            background-size: 20px 20px;
        }
        #receipt-print-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background-color: #2563EB; /* Bande bleue en haut */
        }
        #receipt-print-area::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10px;
            background-color: #10B981; /* Bande verte en bas */
        }
        #receipt-print-area h1 {
            color: #2563EB; /* Titre bleu */
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #2563EB;
            padding-bottom: 15px;
            position: relative;
        }
        #receipt-print-area h1::before {
            content: 'üè†'; /* Symbole maison */
            position: absolute;
            left: 50%;
            transform: translateX(-50%) translateY(-250%);
            font-size: 1.5rem;
            color: #10B981; /* Vert */
        }
        #receipt-print-area .section-header {
            font-weight: bold;
            color: #10B981; /* Vert pour les en-t√™tes de section */
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        #receipt-print-area .info-block {
            padding: 10px;
            border-left: 3px solid #10B981; /* Bande verte sur le c√¥t√© */
            margin-bottom: 1.5rem;
            background-color: #f8fcf8; /* Fond l√©g√®rement vert */
        }
        #receipt-print-area .detail-table {
            width: 100%; /* Tableau prend toute la largeur */
            max-width: 350px; /* Max width for readability */
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #receipt-print-area .detail-table th,
        #receipt-print-area .detail-table td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
        }
        #receipt-print-area .detail-table th {
            background-color: #EBF8FF; /* Bleu clair */
            color: #2563EB;
            font-weight: 600;
        }
        #receipt-print-area .detail-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #receipt-print-area .total-row td {
            font-weight: bold;
            background-color: #EBF8FF; /* Bleu clair */
            color: #2563EB;
        }
        #receipt-print-area .signature-area {
            text-align: center;
            margin-top: 4rem;
            padding-top: 15px;
            border-top: 2px dashed #ccc;
            color: #555;
            font-size: 0.95rem;
        }

        /* Responsive adjustments for print area */
        @media screen and (max-width: 768px) {
            #receipt-print-area {
                padding: 20px;
            }
            #receipt-print-area h1 {
                font-size: 1.8rem;
            }
        }

        /* Masque les √©l√©ments non imprimables lors de l'impression physique */
        @media print {
            body { margin: 0; padding: 0; }
            body > *:not(#receipt-modal):not(#receipt-print-area) { display: none; }
            #receipt-modal {
                position: static; /* Position static pour l'impression */
                background: none;
                box-shadow: none;
            }
            #receipt-modal .no-print { display: none !important; }
            #receipt-print-area {
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                margin: 0;
                padding: 2cm !important; /* Marges pour l'impression physique */
                position: static;
                font-size: 11pt; /* Taille de police pour l'impression */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 font-sans text-gray-800 antialiased">

    <div class="container mx-auto max-w-5xl p-4 sm:p-8 bg-white rounded-xl shadow-lg my-8">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8 tracking-tight">
            <span class="text-green-500">üè†</span> Gestionnaire de Quittances <span class="text-green-500">Immo</span>
        </h1>

        <!-- Onglets de navigation --><div class="mb-6 border-b border-gray-200">
            <div class="sm:hidden">
                <select id="tabs-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="tab-generate">G√©n√©rer Quittance</option>
                    <option value="tab-manage">G√©rer les Donn√©es</option>
                </select>
            </div>
            <div class="hidden sm:block">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button data-tab="tab-generate" class="tab-button active-tab whitespace-nowrap py-4 px-1 text-lg font-medium">
                        G√©n√©rer Quittance
                    </button>
                    <button data-tab="tab-manage" class="tab-button inactive-tab whitespace-nowrap py-4 px-1 text-lg font-medium">
                        G√©rer les Donn√©es
                    </button>
                </nav>
            </div>
        </div>

        <!-- Contenu des onglets --><div>
            <!-- Onglet 1: G√©n√©rer Quittance --><div id="tab-generate" class="tab-content active-content space-y-7 p-4 sm:p-6 bg-white rounded-lg shadow-inner border border-gray-100">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-4 mb-4 text-center">Cr√©ez une Quittance Rapidement</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-7">
                    
                    <!-- Colonne 1: Infos Bailleur, Locataire, Bien --><div class="space-y-5">
                        <div class="field-group">
                            <label for="landlord-select" class="block text-sm font-medium text-gray-600 mb-1">Bailleur <span class="text-red-500">*</span></label>
                            <select id="landlord-select" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"></select>
                        </div>
                        <div class="field-group">
                            <label for="tenant-select" class="block text-sm font-medium text-gray-600 mb-1">Locataire(s) <span class="text-red-500">*</span></label>
                            <select id="tenant-select" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"></select>
                        </div>
                        <div class="field-group">
                            <label for="property-select" class="block text-sm font-medium text-gray-600 mb-1">Bien concern√© <span class="text-red-500">*</span></label>
                            <select id="property-select" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"></select>
                        </div>
                    </div>

                    <!-- Colonne 2: Infos Paiement --><div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="field-group">
                                <label for="rent-amount" class="block text-sm font-medium text-gray-600 mb-1">Montant Loyer (‚Ç¨) <span class="text-red-500">*</span></label>
                                <input type="number" id="rent-amount" placeholder="650.00" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="0">
                            </div>
                            <div class="field-group">
                                <label for="charges-amount" class="block text-sm font-medium text-gray-600 mb-1">Montant Charges (‚Ç¨) <span class="text-red-500">*</span></label>
                                <input type="number" id="charges-amount" placeholder="50.00" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="0">
                            </div>
                        </div>
                        <div class="field-group">
                            <label for="total-words" class="block text-sm font-medium text-gray-600 mb-1">Montant total (en lettres) <span class="text-red-500">*</span></label>
                            <input type="text" id="total-words" placeholder="Sera rempli automatiquement" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm bg-gray-50 focus:outline-none" readonly>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="field-group">
                                <label for="period-start" class="block text-sm font-medium text-gray-600 mb-1">P√©riode du <span class="text-red-500">*</span></label>
                                <input type="date" id="period-start" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="field-group">
                                <label for="period-end" class="block text-sm font-medium text-gray-600 mb-1">P√©riode au <span class="text-red-500">*</span></label>
                                <input type="date" id="period-end" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Colonne 3: Infos R√©daction --><div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t border-gray-200 pt-6 mt-6">
                    <div class="field-group">
                        <label for="payment-date" class="block text-sm font-medium text-gray-600 mb-1">Date de paiement <span class="text-red-500">*</span></label>
                        <input type="date" id="payment-date" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="field-group">
                        <label for="doc-location" class="block text-sm font-medium text-gray-600 mb-1">Fait √† <span class="text-red-500">*</span></label>
                        <input type="text" id="doc-location" placeholder="Votre ville" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="field-group">
                        <label for="doc-date" class="block text-sm font-medium text-gray-600 mb-1">Date de r√©daction <span class="text-red-500">*</span></label>
                        <input type="date" id="doc-date" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="text-center pt-6">
                    <button id="generate-button" class="w-full sm:w-auto px-12 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-3 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:-translate-y-1">
                        G√©n√©rer la Quittance
                    </button>
                </div>
            </div>

            <!-- Onglet 2: G√©rer les Donn√©es --><div id="tab-manage" class="tab-content inactive-content p-4 sm:p-6 bg-white rounded-lg shadow-inner border border-gray-100">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-4 mb-4 text-center">G√©rer vos informations cl√©s</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-7">

                    <!-- Section Bailleurs --><div class="border border-blue-200 rounded-lg p-5 bg-blue-50 shadow-sm">
                        <h3 class="text-xl font-semibold text-blue-700 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            Bailleur(s)
                        </h3>
                        <form id="landlord-form" class="space-y-4">
                            <input type="text" id="landlord-name" placeholder="Nom Pr√©nom / Raison Sociale" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm" required>
                            <textarea id="landlord-address" placeholder="Adresse compl√®te du bailleur" rows="3" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm" required></textarea>
                            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md hover:bg-blue-700 transition duration-200">Ajouter/Mettre √† jour</button>
                        </form>
                        <ul id="landlord-list" class="mt-5 space-y-3"></ul>
                    </div>

                    <!-- Section Locataires --><div class="border border-green-200 rounded-lg p-5 bg-green-50 shadow-sm">
                        <h3 class="text-xl font-semibold text-green-700 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h2a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-2.414-2.414A1 1 0 0015.586 6H10a2 2 0 00-2 2v10a2 2 0 002 2h6m-7-2v-2m0 2v-5a2 2 0 012-2h2a2 2 0 012 2v5m-7 0h7"></path></svg>
                            Locataires
                        </h3>
                        <form id="tenant-form" class="space-y-4">
                            <input type="text" id="tenant-name" placeholder="Nom(s) du/des locataire(s)" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm" required>
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md hover:bg-green-700 transition duration-200">Ajouter</button>
                        </form>
                        <ul id="tenant-list" class="mt-5 space-y-3"></ul>
                    </div>

                    <!-- Section Propri√©t√©s --><div class="border border-yellow-200 rounded-lg p-5 bg-yellow-50 shadow-sm">
                        <h3 class="text-xl font-semibold text-yellow-700 mb-4 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                            Propri√©t√©s
                        </h3>
                        <form id="property-form" class="space-y-4">
                            <textarea id="property-address" placeholder="Adresse compl√®te de la propri√©t√©" rows="3" class="w-full p-2.5 border border-gray-300 rounded-md shadow-sm" required></textarea>
                            <button type="submit" class="w-full px-4 py-2 bg-yellow-600 text-white text-base font-medium rounded-md hover:bg-yellow-700 transition duration-200">Ajouter</button>
                        </form>
                        <ul id="property-list" class="mt-5 space-y-3"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de pr√©visualisation de la quittance --><div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[95vh] flex flex-col">
            <!-- En-t√™te de la modale --><div class="no-print flex justify-between items-center p-4 sm:p-5 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold text-gray-800">Aper√ßu de la Quittance</h2>
                <div>
                    <button id="download-pdf-button" class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-md mr-3 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200">
                        T√©l√©charger PDF
                    </button>
                    <button id="print-button" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-md mr-3 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200">
                        Imprimer
                    </button>
                    <button id="close-modal" class="px-5 py-2.5 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-75 transition duration-200">
                        &times; Fermer
                    </button>
                </div>
            </div>
            
            <!-- Contenu imprimable de la quittance --><div id="receipt-print-area" class="flex-grow p-8 sm:p-10 overflow-y-auto">
                <!-- Contenu dynamique g√©n√©r√© par JS --></div>
        </div>
    </div>

    <script type="module">
        // ----- STATE & STORAGE -----
        let landlords = [];
        let tenants = [];
        let properties = [];

        // Fonctions utilitaires pour le Local Storage
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data))
        };

        // ----- DOM ELEMENTS -----
        const landlordForm = document.getElementById('landlord-form');
        const landlordNameInput = document.getElementById('landlord-name');
        const landlordAddressInput = document.getElementById('landlord-address');
        const landlordList = document.getElementById('landlord-list');
        
        const tenantForm = document.getElementById('tenant-form');
        const tenantNameInput = document.getElementById('tenant-name');
        const tenantList = document.getElementById('tenant-list');

        const propertyForm = document.getElementById('property-form');
        const propertyAddressInput = document.getElementById('property-address');
        const propertyList = document.getElementById('property-list');

        const landlordSelect = document.getElementById('landlord-select');
        const tenantSelect = document.getElementById('tenant-select');
        const propertySelect = document.getElementById('property-select');

        const rentAmountInput = document.getElementById('rent-amount');
        const chargesAmountInput = document.getElementById('charges-amount');
        const totalWordsInput = document.getElementById('total-words');

        const generateButton = document.getElementById('generate-button');
        const modal = document.getElementById('receipt-modal');
        const closeModalButton = document.getElementById('close-modal');
        const printButton = document.getElementById('print-button');
        const downloadPdfButton = document.getElementById('download-pdf-button'); // Nouveau bouton
        const receiptContent = document.getElementById('receipt-print-area');

        // ----- DATE & NUMBER UTILS -----
        const formatDate = (dateString) => {
            if (!dateString) return '__________';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        };
        
        const getToday = () => new Date().toISOString().split('T')[0];

        // Fonction pour convertir un nombre en mots (fran√ßais) - Simplifi√©e pour l'exemple
        const numberToWords = (num) => {
            if (num === 0) return "z√©ro euro";
            const units = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf", "dix", "onze", "douze", "treize", "quatorze", "quinze", "seize"];
            const tens = ["", "", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante-dix", "quatre-vingt", "quatre-vingt-dix"];
            
            let s = Math.floor(num).toString();
            let c = (num - Math.floor(num)).toFixed(2).substring(2); // Centimes
            let result = "";

            const convertChunk = (n) => {
                if (n < 17) return units[n];
                if (n < 20) return units[n % 10] + "ze"; // Treize, quatorze etc.
                if (n < 70) return tens[Math.floor(n / 10)] + (n % 10 === 1 && n !== 21 && n !== 31 && n !== 41 && n !== 51 && n !== 61 ? " et " : "-") + units[n % 10];
                if (n < 80) return "soixante-" + convertChunk(n - 60);
                if (n < 90) return "quatre-vingt" + (n > 80 ? "-" + units[n % 10] : "");
                if (n < 100) return "quatre-vingt-" + convertChunk(n - 80);
                return ""; // Pour le moment, ne g√®re pas plus de 99
            };

            // G√®re les nombres jusqu'√† 999.99
            const convertHundreds = (n) => {
                let text = "";
                const h = Math.floor(n / 100);
                const r = n % 100;
                if (h > 0) {
                    text += (h === 1 ? "" : units[h] + " ") + "cent" + (h > 1 && r === 0 ? "s" : "") + (r > 0 ? " " : "");
                }
                if (r > 0) {
                    text += convertChunk(r);
                }
                return text;
            };

            let euros = Math.floor(num);
            let centimes = Math.round((num - euros) * 100);

            if (euros > 0) {
                result += convertHundreds(euros) + (euros > 1 ? " euros" : " euro");
            }

            if (centimes > 0) {
                result += (euros > 0 ? " et " : "") + convertChunk(centimes) + (centimes > 1 ? " centimes" : " centime");
            }
            
            return result.trim().replace(/\s+/g, ' '); // Nettoie les espaces multiples
        };

        // Fonction pour mettre √† jour le montant en lettres
        const updateAmountInWords = () => {
            const rent = parseFloat(rentAmountInput.value) || 0;
            const charges = parseFloat(chargesAmountInput.value) || 0;
            const total = rent + charges;
            totalWordsInput.value = numberToWords(total);
        };

        rentAmountInput.addEventListener('input', updateAmountInWords);
        chargesAmountInput.addEventListener('input', updateAmountInWords);

        // ----- RENDER FUNCTIONS -----

        // Fonction g√©n√©rique pour cr√©er un item de liste avec bouton de suppression
        function createListItem(item, text, list, deleteFn) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3 bg-white rounded-md shadow-sm border border-gray-200 text-sm';
            
            const span = document.createElement('span');
            span.className = 'whitespace-pre-wrap flex-1 mr-3 text-gray-700';
            span.textContent = text;
            li.appendChild(span);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Supprimer';
            deleteBtn.className = 'px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-md hover:bg-red-600 transition duration-200';
            deleteBtn.onclick = () => deleteFn(item);
            
            li.appendChild(deleteBtn);
            list.appendChild(li);
        }

        // Fonction g√©n√©rique pour peupler un <select>
        function populateSelect(select, items, textFn) {
            select.innerHTML = '<option value="" disabled selected>-- S√©lectionner --</option>';
            items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index; // Utilise l'index comme valeur
                option.textContent = textFn(item);
                select.appendChild(option);
            });
        }

        // Rendu des listes et s√©lecteurs
        function renderAll() {
            // Bailleur
            landlordList.innerHTML = '';
            landlords.forEach(item => createListItem(item, `${item.name}\n${item.address}`, landlordList, deleteLandlord));
            populateSelect(landlordSelect, landlords, item => item.name);
            
            // Locataires
            tenantList.innerHTML = '';
            tenants.forEach(item => createListItem(item, item.name, tenantList, deleteTenant));
            populateSelect(tenantSelect, tenants, item => item.name);

            // Propri√©t√©s
            propertyList.innerHTML = '';
            properties.forEach(item => createListItem(item, item.address, propertyList, deleteProperty));
            populateSelect(propertySelect, properties, item => item.address);
        }
        
        // ----- DATA MANAGEMENT (CRUD) -----

        // --- Landlord ---
        landlordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newLandlord = {
                name: landlordNameInput.value,
                address: landlordAddressInput.value
            };
            // Remplace le bailleur existant ou l'ajoute (on en garde qu'un pour simplifier)
            // Si vous avez plusieurs bailleurs, il faudra adapter cette logique
            landlords = [newLandlord]; 
            Storage.set('landlords', landlords);
            renderAll();
            // landlordForm.reset(); // Ne pas reset si on veut qu'il reste pr√©-rempli
        });

        function deleteLandlord(itemToDelete) {
            landlords = landlords.filter(item => item !== itemToDelete);
            Storage.set('landlords', landlords);
            renderAll();
            // Clear inputs if the deleted landlord was the only one
            if (landlords.length === 0) {
                landlordNameInput.value = '';
                landlordAddressInput.value = '';
            }
        }

        // --- Tenant ---
        tenantForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (tenantNameInput.value) {
                tenants.push({ name: tenantNameInput.value });
                Storage.set('tenants', tenants);
                renderAll();
                tenantNameInput.value = ''; // Reset only the name input
            }
        });

        function deleteTenant(itemToDelete) {
            tenants = tenants.filter(item => item !== itemToDelete);
            Storage.set('tenants', tenants);
            renderAll();
        }

        // --- Property ---
        propertyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (propertyAddressInput.value) {
                properties.push({ address: propertyAddressInput.value });
                Storage.set('properties', properties);
                renderAll();
                propertyAddressInput.value = ''; // Reset only the address input
            }
        });

        function deleteProperty(itemToDelete) {
            properties = properties.filter(item => item !== itemToDelete);
            Storage.set('properties', properties);
            renderAll();
        }

        // ----- RECEIPT GENERATION -----
        generateButton.addEventListener('click', () => {
            // 1. R√©cup√©rer les donn√©es s√©lectionn√©es
            const selectedLandlordIndex = landlordSelect.value;
            const selectedTenantIndex = tenantSelect.value;
            const selectedPropertyIndex = propertySelect.value;

            const landlord = landlords[selectedLandlordIndex];
            const tenant = tenants[selectedTenantIndex];
            const property = properties[selectedPropertyIndex];

            // 2. R√©cup√©rer les valeurs du formulaire
            const rent = parseFloat(rentAmountInput.value) || 0;
            const charges = parseFloat(chargesAmountInput.value) || 0;
            const total = rent + charges;
            const totalWords = totalWordsInput.value; // D√©j√† rempli par la fonction updateAmountInWords
            
            const periodStart = formatDate(document.getElementById('period-start').value);
            const periodEnd = formatDate(document.getElementById('period-end').value);
            const paymentDate = formatDate(document.getElementById('payment-date').value);
            const docLocation = document.getElementById('doc-location').value;
            const docDate = formatDate(document.getElementById('doc-date').value);

            // 3. Validation
            if (!landlord || !tenant || !property || !totalWords || !periodStart || !periodEnd || !paymentDate || !docLocation || !docDate || total === 0) {
                alert("Veuillez remplir tous les champs obligatoires (marqu√©s d'une *) et vous assurer que le montant total n'est pas z√©ro.");
                return;
            }

            // 4. G√©n√©rer le HTML de la quittance
            receiptContent.innerHTML = `
                <h1 class="font-poppins">QUITTANCE DE LOYER</h1>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <div class="info-block" style="flex: 1; margin-right: 1rem;">
                        <div class="section-header">Bailleur :</div>
                        <p>${landlord.name.replace(/\n/g, '<br>')}</p>
                        <p>${landlord.address.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="info-block" style="flex: 1; margin-left: 1rem;">
                        <div class="section-header">Locataire(s) :</div>
                        <p>${tenant.name.replace(/\n/g, '<br>')}</p>
                    </div>
                </div>

                <div class="info-block" style="margin-bottom: 2rem;">
                    <div class="section-header">Bien concern√© :</div>
                    <p>${property.address.replace(/\n/g, '<br>')}</p>
                </div>

                <p style="margin-bottom: 1.5rem; font-size: 1.1rem;">
                    Je soussign√©(e), <strong style="color: #2563EB;">${landlord.name}</strong>, bailleur, d√©clare avoir re√ßu de <strong style="color: #10B981;">${tenant.name}</strong>
                    la somme de <strong style="color: #2563EB; font-size: 1.2rem;">${total.toFixed(2).replace('.', ',')} ‚Ç¨</strong>
                    (<i>${totalWords}</i>),
                    au titre du paiement du loyer et des charges pour la p√©riode du <strong style="color: #10B981;">${periodStart}</strong> au <strong style="color: #10B981;">${periodEnd}</strong>.
                    Cette somme a √©t√© re√ßue le <strong style="color: #10B981;">${paymentDate}</strong>.
                </p>

                <p style="margin-bottom: 1.5rem; font-weight: 500;">D√©tail du r√®glement :</p>
                
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>D√©signation</th>
                            <th style="text-align: right;">Montant</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Loyer</td>
                            <td style="text-align: right;">${rent.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                        </tr>
                        <tr>
                            <td>Provisions sur charges</td>
                            <td style="text-align: right;">${charges.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>TOTAL</strong></td>
                            <td style="text-align: right;"><strong>${total.toFixed(2).replace('.', ',')} ‚Ç¨</strong></td>
                        </tr>
                    </tbody>
                </table>

                <p style="margin-bottom: 2rem; font-style: italic; font-size: 0.95rem; color: #555;">
                    Cette quittance annule tous les re√ßus qui auraient pu √™tre donn√©s pour les sommes vers√©es au titre des loyers et charges pour cette m√™me p√©riode.
                    <br>
                    Sous r√©serve de tous droits.
                </p>

                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 3rem;">
                    <div>
                        Fait √† <strong style="color: #2563EB;">${docLocation}</strong>, le <strong style="color: #10B981;">${docDate}</strong>.
                    </div>
                    <div class="signature-area">
                        Signature du bailleur<br>
                        <strong style="color: #2563EB;">${landlord.name}</strong>
                    </div>
                </div>
            `;

            // 5. Afficher la modale
            modal.classList.remove('hidden');
        });

        // ----- MODAL & PRINT CONTROLS -----
        closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
        printButton.addEventListener('click', () => window.print());

        // G√©rer le t√©l√©chargement PDF
        downloadPdfButton.addEventListener('click', () => {
            const element = document.getElementById('receipt-print-area');
            const landlord = landlords[landlordSelect.value]; // Get selected landlord for filename
            const tenant = tenants[tenantSelect.value]; // Get selected tenant for filename
            const periodStart = document.getElementById('period-start').value; // Get period start for filename
            
            // Generate a filename
            const filename = `Quittance_Loyer_${landlord ? landlord.name.replace(/[^a-zA-Z0-9]/g, '') : 'Bailleur'}_${tenant ? tenant.name.replace(/[^a-zA-Z0-9]/g, '') : 'Locataire'}_${periodStart || getToday()}.pdf`;

            // Options pour html2pdf
            const options = {
                margin: [10, 10, 10, 10], // top, left, bottom, right
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(options).from(element).save();
        });


        // ----- TABS -----
        const tabs = document.querySelectorAll('.tab-button');
        const tabSelect = document.getElementById('tabs-select');
        const contents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
            contents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('inactive-content');
                    content.classList.add('active-content');
                } else {
                    content.classList.remove('active-content');
                    content.classList.add('inactive-content');
                }
            });

            tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active-tab');
                    tab.classList.remove('inactive-tab');
                } else {
                    tab.classList.add('inactive-tab');
                    tab.classList.remove('active-tab');
                }
            });
            // Met √† jour le select mobile
            tabSelect.value = tabId;
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        tabSelect.addEventListener('change', (e) => switchTab(e.target.value));

        // ----- INITIALIZATION -----
        document.addEventListener('DOMContentLoaded', () => {
            // Charger les donn√©es depuis le Local Storage
            landlords = Storage.get('landlords');
            tenants = Storage.get('tenants');
            properties = Storage.get('properties');

            // Remplir les formulaires et listes
            renderAll();
            
            // Pr√©-remplir le bailleur s'il n'y en a qu'un dans les inputs de l'onglet "G√©rer"
            if (landlords.length > 0) {
                landlordNameInput.value = landlords[0].name;
                landlordAddressInput.value = landlords[0].address;
            }

            // S√©lectionner le premier √©l√©ment par d√©faut si la liste n'est pas vide
            if (landlordSelect.options.length > 1) landlordSelect.value = landlords.length > 0 ? 0 : '';
            if (tenantSelect.options.length > 1) tenantSelect.value = tenants.length > 0 ? 0 : '';
            if (propertySelect.options.length > 1) propertySelect.value = properties.length > 0 ? 0 : '';


            // Pr√©-remplir les dates
            document.getElementById('payment-date').value = getToday();
            document.getElementById('doc-date').value = getToday();
            
            // Pr√©-remplir le champ "Fait √†" si une adresse de bailleur existe
            if (landlords.length > 0 && landlords[0].address) {
                const parts = landlords[0].address.split('\n');
                if (parts.length > 1) {
                    const lastLine = parts[parts.length - 1];
                    const zipCityMatch = lastLine.match(/(\d{5})\s+(.+)/);
                    if (zipCityMatch) {
                        document.getElementById('doc-location').value = zipCityMatch[2].trim();
                    } else {
                        document.getElementById('doc-location').value = lastLine.trim();
                    }
                }
            }


            // Mettre √† jour le montant en lettres au chargement
            updateAmountInWords();

            // Activer le premier onglet
            switchTab('tab-generate');
        });

    </script>
</body>
</html>
