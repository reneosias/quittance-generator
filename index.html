<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Quittances de Loyer</title>
    <!-- Importation de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles pour l'impression de la quittance */
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            /* Cache tout sauf la zone d'impression */
            body > * {
                display: none;
            }
            #receipt-print-area,
            #receipt-print-area * {
                display: block;
                visibility: visible;
            }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 2cm; /* Marges d'impression */
                font-family: 'Times New Roman', Times, serif;
                font-size: 12pt;
                color: #000;
            }
            /* Cache les boutons dans la version imprimée */
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800" style="font-family: 'Inter', sans-serif;">

    <div class="container mx-auto max-w-5xl p-4 sm:p-8">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">Gestionnaire de Quittances de Loyer</h1>

        <!-- Onglets de navigation -->
        <div class="mb-6">
            <div class="sm:hidden">
                <select id="tabs-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="tab-generate">Générer Quittance</option>
                    <option value="tab-manage">Gérer les Données</option>
                </select>
            </div>
            <div class="hidden sm:block">
                <nav class="flex border-b border-gray-300">
                    <button data-tab="tab-generate" class="tab-button active-tab -mb-px whitespace-nowrap border-b-2 border-transparent py-4 px-6 text-base font-medium leading-5 text-gray-500 hover:border-gray-300 hover:text-gray-700 focus:outline-none">
                        Générer Quittance
                    </button>
                    <button data-tab="tab-manage" class="tab-button inactive-tab -mb-px whitespace-nowrap border-b-2 border-transparent py-4 px-6 text-base font-medium leading-5 text-gray-500 hover:border-gray-300 hover:text-gray-700 focus:outline-none">
                        Gérer les Données
                    </button>
                </nav>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <div>
            <!-- Onglet 1: Générer Quittance -->
            <div id="tab-generate" class="tab-content active-content space-y-6 p-4 sm:p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3">Nouvelle Quittance</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Colonne 1: Infos Bailleur, Locataire, Bien -->
                    <div class="space-y-4">
                        <div>
                            <label for="landlord-select" class="block text-sm font-medium text-gray-600 mb-1">Bailleur</label>
                            <select id="landlord-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label for="tenant-select" class="block text-sm font-medium text-gray-600 mb-1">Locataire(s)</label>
                            <select id="tenant-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label for="property-select" class="block text-sm font-medium text-gray-600 mb-1">Bien concerné</label>
                            <select id="property-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                    </div>

                    <!-- Colonne 2: Infos Paiement -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="rent-amount" class="block text-sm font-medium text-gray-600 mb-1">Montant Loyer (€)</label>
                                <input type="number" id="rent-amount" placeholder="650.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="charges-amount" class="block text-sm font-medium text-gray-600 mb-1">Montant Charges (€)</label>
                                <input type="number" id="charges-amount" placeholder="50.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="total-words" class="block text-sm font-medium text-gray-600 mb-1">Montant total (en lettres)</label>
                            <input type="text" id="total-words" placeholder="Sept cents euros" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="period-start" class="block text-sm font-medium text-gray-600 mb-1">Période du</label>
                                <input type="date" id="period-start" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="period-end" class="block text-sm font-medium text-gray-600 mb-1">Période au</label>
                                <input type="date" id="period-end" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Colonne 3: Infos Rédaction -->
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t pt-6">
                    <div>
                        <label for="payment-date" class="block text-sm font-medium text-gray-600 mb-1">Date de paiement</label>
                        <input type="date" id="payment-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="doc-location" class="block text-sm font-medium text-gray-600 mb-1">Fait à</label>
                        <input type="text" id="doc-location" placeholder="Paris" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="doc-date" class="block text-sm font-medium text-gray-600 mb-1">Date de rédaction</label>
                        <input type="date" id="doc-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="text-center pt-4">
                    <button id="generate-button" class="w-full sm:w-auto px-10 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200">
                        Générer la Quittance
                    </button>
                </div>
            </div>

            <!-- Onglet 2: Gérer les Données -->
            <div id="tab-manage" class="tab-content inactive-content p-4 sm:p-6 bg-white rounded-lg shadow-md">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Section Bailleurs -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Bailleur(s)</h3>
                        <form id="landlord-form" class="space-y-3">
                            <input type="text" id="landlord-name" placeholder="Nom Prénom / Raison Sociale" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                            <textarea id="landlord-address" placeholder="Adresse complète du bailleur" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700">Ajouter/Mettre à jour</button>
                        </form>
                        <ul id="landlord-list" class="mt-4 space-y-2"></ul>
                    </div>

                    <!-- Section Locataires -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Locataires</h3>
                        <form id="tenant-form" class="space-y-3">
                            <input type="text" id="tenant-name" placeholder="Nom(s) du/des locataire(s)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700">Ajouter</button>
                        </form>
                        <ul id="tenant-list" class="mt-4 space-y-2"></ul>
                    </div>

                    <!-- Section Propriétés -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Propriétés</h3>
                        <form id="property-form" class="space-y-3">
                            <textarea id="property-address" placeholder="Adresse complète de la propriété" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700">Ajouter</tr>
                        </form>
                        <ul id="property-list" class="mt-4 space-y-2"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de prévisualisation de la quittance -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <!-- En-tête de la modale -->
            <div class="no-print flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold">Aperçu de la Quittance</h2>
                <div>
                    <button id="print-button" class="px-4 py-2 bg-blue-600 text-white rounded-md mr-2 hover:bg-blue-700">Imprimer</button>
                    <button id="close-modal" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">&times; Fermer</button>
                </div>
            </div>
            
            <!-- Contenu imprimable de la quittance -->
            <div id="receipt-print-area" class="p-8 font-serif text-base text-black">
                <!-- Contenu dynamique généré par JS -->
            </div>
        </div>
    </div>

    <script type="module">
        // ----- STATE & STORAGE -----
        let landlords = [];
        let tenants = [];
        let properties = [];

        // Fonctions utilitaires pour le Local Storage
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data))
        };

        // ----- DOM ELEMENTS -----
        const landlordForm = document.getElementById('landlord-form');
        const landlordName = document.getElementById('landlord-name');
        const landlordAddress = document.getElementById('landlord-address');
        const landlordList = document.getElementById('landlord-list');
        
        const tenantForm = document.getElementById('tenant-form');
        const tenantName = document.getElementById('tenant-name');
        const tenantList = document.getElementById('tenant-list');

        const propertyForm = document.getElementById('property-form');
        const propertyAddress = document.getElementById('property-address');
        const propertyList = document.getElementById('property-list');

        const landlordSelect = document.getElementById('landlord-select');
        const tenantSelect = document.getElementById('tenant-select');
        const propertySelect = document.getElementById('property-select');

        const generateButton = document.getElementById('generate-button');
        const modal = document.getElementById('receipt-modal');
        const closeModalButton = document.getElementById('close-modal');
        const printButton = document.getElementById('print-button');
        const receiptContent = document.getElementById('receipt-print-area');

        // ----- DATE UTILS -----
        const formatDate = (dateString) => {
            if (!dateString) return '__________';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        };
        
        const getToday = () => new Date().toISOString().split('T')[0];

        // ----- RENDER FUNCTIONS -----

        // Fonction générique pour créer un item de liste avec bouton de suppression
        function createListItem(item, text, list, deleteFn) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md text-sm';
            
            const span = document.createElement('span');
            span.className = 'whitespace-pre-wrap flex-1 mr-2';
            span.textContent = text;
            li.appendChild(span);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Suppr.';
            deleteBtn.className = 'px-2 py-1 bg-red-500 text-white text-xs font-medium rounded-md hover:bg-red-600';
            deleteBtn.onclick = () => deleteFn(item);
            
            li.appendChild(deleteBtn);
            list.appendChild(li);
        }

        // Fonction générique pour peupler un <select>
        function populateSelect(select, items, textFn) {
            select.innerHTML = '<option value="">-- Sélectionner --</option>';
            items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index; // Utilise l'index comme valeur
                option.textContent = textFn(item);
                select.appendChild(option);
            });
        }

        // Rendu des listes et sélecteurs
        function renderAll() {
            // Bailleur
            landlordList.innerHTML = '';
            landlords.forEach(item => createListItem(item, `${item.name}\n${item.address}`, landlordList, deleteLandlord));
            populateSelect(landlordSelect, landlords, item => item.name);
            
            // Locataires
            tenantList.innerHTML = '';
            tenants.forEach(item => createListItem(item, item.name, tenantList, deleteTenant));
            populateSelect(tenantSelect, tenants, item => item.name);

            // Propriétés
            propertyList.innerHTML = '';
            properties.forEach(item => createListItem(item, item.address, propertyList, deleteProperty));
            populateSelect(propertySelect, properties, item => item.address);
        }
        
        // ----- DATA MANAGEMENT (CRUD) -----

        // --- Landlord ---
        landlordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newLandlord = {
                name: landlordName.value,
                address: landlordAddress.value
            };
            // Remplace le bailleur existant ou l'ajoute (on en garde qu'un pour simplifier)
            landlords = [newLandlord];
            Storage.set('landlords', landlords);
            renderAll();
            landlordForm.reset();
        });

        function deleteLandlord(itemToDelete) {
            landlords = landlords.filter(item => item !== itemToDelete);
            Storage.set('landlords', landlords);
            renderAll();
        }

        // --- Tenant ---
        tenantForm.addEventListener('submit', (e) => {
            e.preventDefault();
            tenants.push({ name: tenantName.value });
            Storage.set('tenants', tenants);
            renderAll();
            tenantForm.reset();
        });

        function deleteTenant(itemToDelete) {
            tenants = tenants.filter(item => item !== itemToDelete);
            Storage.set('tenants', tenants);
            renderAll();
        }

        // --- Property ---
        propertyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            properties.push({ address: propertyAddress.value });
            Storage.set('properties', properties);
            renderAll();
            propertyForm.reset();
        });

        function deleteProperty(itemToDelete) {
            properties = properties.filter(item => item !== itemToDelete);
            Storage.set('properties', properties);
            renderAll();
        }

        // ----- RECEIPT GENERATION -----
        generateButton.addEventListener('click', () => {
            // 1. Récupérer les données sélectionnées
            const landlord = landlords[landlordSelect.value];
            const tenant = tenants[tenantSelect.value];
            const property = properties[propertySelect.value];

            // 2. Récupérer les valeurs du formulaire
            const rent = parseFloat(document.getElementById('rent-amount').value) || 0;
            const charges = parseFloat(document.getElementById('charges-amount').value) || 0;
            const total = rent + charges;
            const totalWords = document.getElementById('total-words').value;
            
            const periodStart = formatDate(document.getElementById('period-start').value);
            const periodEnd = formatDate(document.getElementById('period-end').value);
            const paymentDate = formatDate(document.getElementById('payment-date').value);
            const docLocation = document.getElementById('doc-location').value || '__________';
            const docDate = formatDate(document.getElementById('doc-date').value);

            // 3. Validation (simpliste)
            if (!landlord || !tenant || !property || !totalWords || !periodStart || !periodEnd || !paymentDate || !docDate) {
                alert("Veuillez remplir tous les champs et vous assurer d'avoir sélectionné un bailleur, un locataire et une propriété.");
                return;
            }

            // 4. Générer le HTML de la quittance
            receiptContent.innerHTML = `
                <h1 style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 2rem;">QUITTANCE DE LOYER</h1>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <div>
                        <strong>Bailleur :</strong><br>
                        ${landlord.name.replace(/\n/g, '<br>')}<br>
                        ${landlord.address.replace(/\n/g, '<br>')}
                    </div>
                    <div>
                        <strong>Locataire(s) :</strong><br>
                        ${tenant.name.replace(/\n/g, '<br>')}
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <strong>Bien concerné :</strong><br>
                    ${property.address.replace(/\n/g, '<br>')}
                </div>

                <p style="margin-bottom: 1.5rem;">
                    Je soussigné(e), ${landlord.name}, bailleur, déclare avoir reçu de ${tenant.name}
                    la somme de <strong>${total.toFixed(2)} €</strong>
                    (<i>${totalWords}</i>),
                    au titre du paiement du loyer et des charges pour la période du <strong>${periodStart}</strong> au <strong>${periodEnd}</strong>.
                    Cette somme a été reçue le <strong>${paymentDate}</strong>.
                </p>

                <p style="margin-bottom: 1.5rem;">Détail du règlement :</p>
                
                <table style="width: 300px; border-collapse: collapse; margin-bottom: 1.5rem;">
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;">Loyer</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${rent.toFixed(2)} €</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;">Provisions sur charges</td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;">${charges.toFixed(2)} €</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;"><strong>TOTAL</strong></td>
                            <td style="border: 1px solid #000; padding: 8px; text-align: right;"><strong>${total.toFixed(2)} €</strong></td>
                        </tr>
                    </tbody>
                </table>

                <p style="margin-bottom: 2rem; font-style: italic; font-size: 0.9rem;">
                    Cette quittance annule tous les reçus qui auraient pu être donnés pour les sommes versées au titre des loyers et charges pour cette même période.
                    <br>
                    Sous réserve de tous droits.
                </p>

                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 3rem;">
                    <div>
                        Fait à ${docLocation}, le ${docDate}.
                    </div>
                    <div style="border-top: 1px solid #000; padding-top: 5px; width: 200px; text-align: center;">
                        Signature du bailleur
                    </div>
                </div>
            `;

            // 5. Afficher la modale
            modal.classList.remove('hidden');
        });

        // ----- MODAL & PRINT CONTROLS -----
        closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
        printButton.addEventListener('click', () => window.print());

        // ----- TABS -----
        const tabs = document.querySelectorAll('.tab-button');
        const tabSelect = document.getElementById('tabs-select');
        const contents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
            contents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('inactive-content');
                    content.classList.add('active-content');
                } else {
                    content.classList.remove('active-content');
                    content.classList.add('inactive-content');
                }
            });

            tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active-tab');
                    tab.classList.remove('inactive-tab');
                } else {
                    tab.classList.add('inactive-tab');
                    tab.classList.remove('active-tab');
                }
            });
            // Met à jour le select mobile
            tabSelect.value = tabId;
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        tabSelect.addEventListener('change', (e) => switchTab(e.target.value));

        // Styles des onglets
        const style = document.createElement('style');
        style.innerHTML = `
            .tab-content.inactive-content { display: none; }
            .tab-content.active-content { display: block; }
            .tab-button.active-tab { 
                border-color: #2563EB; /* blue-600 */
                color: #2563EB;
                font-weight: 600;
            }
            .tab-button.inactive-tab {
                border-color: transparent;
            }
        `;
        document.head.appendChild(style);


        // ----- INITIALIZATION -----
        document.addEventListener('DOMContentLoaded', () => {
            // Charger les données depuis le Local Storage
            landlords = Storage.get('landlords');
            tenants = Storage.get('tenants');
            properties = Storage.get('properties');

            // Remplir les formulaires et listes
            renderAll();
            
            // Pré-remplir le bailleur s'il n'y en a qu'un
            if (landlords.length > 0) {
                landlordName.value = landlords[0].name;
                landlordAddress.value = landlords[0].address;
            }

            // Pré-remplir les dates
            document.getElementById('payment-date').value = getToday();
            document.getElementById('doc-date').value = getToday();

            // Activer le premier onglet
            switchTab('tab-generate');
        });

    </script>
</body>
</html>
