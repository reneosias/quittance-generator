<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Quittances de Loyer</title>
    <!-- Chargement de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Police de caractères Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Styles pour l'impression */
        @media print {
            /* Cache tout sauf la zone d'impression */
            body * {
                visibility: hidden;
            }
            #receipt-preview, #receipt-preview * {
                visibility: visible;
            }
            #receipt-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10px;
                box-shadow: none;
                border: none;
            }
            /* Cache les éléments de l'interface dans la zone d'impression */
            .no-print {
                display: none;
            }
        }
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styles pour les champs de formulaire */
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .form-section {
            @apply bg-white p-6 rounded-lg shadow-md mb-6;
        }
        .form-title {
            @apply text-xl font-semibold text-gray-800 mb-4 border-b pb-2;
        }
        .btn {
            @apply px-4 py-2 rounded-md font-medium text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-danger {
             @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700 focus:ring-green-500;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        
        <h1 class="text-3xl font-bold text-center text-gray-900 mb-8">Générateur de Quittance de Loyer</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Colonne de gauche : Panneau de contrôle -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                
                <!-- Section Gestion (Propriétaires, Locataires, Biens) -->
                <div class="form-section">
                    <h2 class="form-title">Gestion</h2>
                    
                    <!-- Gérer les Propriétaires -->
                    <div>
                        <label for="owner-select" class="form-label">Propriétaire</label>
                        <div class="flex gap-2">
                            <select id="owner-select" class="form-input"></select>
                            <button id="delete-owner-btn" class="btn btn-danger no-print" title="Supprimer le propriétaire sélectionné">X</button>
                        </div>
                    </div>
                    <details class="mt-4 text-sm">
                        <summary class="cursor-pointer font-medium text-blue-600">Ajouter/Modifier un propriétaire</summary>
                        <div class="mt-4 space-y-3">
                            <div>
                                <label for="owner-name" class="form-label">Nom du propriétaire</label>
                                <input type="text" id="owner-name" class="form-input" value="René Osias ASSENDAHI">
                            </div>
                            <div>
                                <label for="owner-phone" class="form-label">Téléphone</label>
                                <input type="text" id="owner-phone" class="form-input" value="0668336085">
                            </div>
                            <div>
                                <label for="owner-email" class="form-label">Email</label>
                                <input type="email" id="owner-email" class="form-input" value="essonne1992@gmail.com">
                            </div>
                            <button id="save-owner-btn" class="btn btn-secondary w-full no-print">Sauvegarder Propriétaire</button>
                        </div>
                    </details>
                    
                    <hr class="my-6">

                    <!-- Gérer les Locataires -->
                    <div>
                        <label for="tenant-select" class="form-label">Locataire</label>
                         <div class="flex gap-2">
                            <select id="tenant-select" class="form-input"></select>
                            <button id="delete-tenant-btn" class="btn btn-danger no-print" title="Supprimer le locataire sélectionné">X</button>
                        </div>
                    </div>
                     <details class="mt-4 text-sm">
                        <summary class="cursor-pointer font-medium text-blue-600">Ajouter/Modifier un locataire</summary>
                        <div class="mt-4 space-y-3">
                            <div>
                                <label for="tenant-name" class="form-label">Nom du locataire</label>
                                <input type="text" id="tenant-name" class="form-input" value="SOLIHA SEINE ET MARNE">
                            </div>
                            <div>
                                <label for="tenant-address" class="form-label">Adresse du locataire</label>
                                <textarea id="tenant-address" class="form-input" rows="2">76 rue dian fossey 77000 melun</textarea>
                            </div>
                            <button id="save-tenant-btn" class="btn btn-secondary w-full no-print">Sauvegarder Locataire</button>
                        </div>
                    </details>

                    <hr class="my-6">

                    <!-- Gérer les Biens -->
                    <div>
                        <label for="property-select" class="form-label">Bien Immobilier</label>
                         <div class="flex gap-2">
                            <select id="property-select" class="form-input"></select>
                            <button id="delete-property-btn" class="btn btn-danger no-print" title="Supprimer le bien sélectionné">X</button>
                        </div>
                    </div>
                     <details class="mt-4 text-sm">
                        <summary class="cursor-pointer font-medium text-blue-600">Ajouter/Modifier un bien</summary>
                        <div class="mt-4 space-y-3">
                            <div>
                                <label for="property-address" class="form-label">Adresse du bien</label>
                                <textarea id="property-address" class="form-input" rows="2">76 rue dian fossey 77000 melun</textarea>
                            </div>
                            <button id="save-property-btn" class="btn btn-secondary w-full no-print">Sauvegarder Bien</button>
                        </div>
                    </details>
                </div>
                
                <!-- Section Détails de la Quittance -->
                <div class="form-section">
                    <h2 class="form-title">Détails de la Quittance</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="period-start" class="form-label">Début de période</label>
                                <input type="date" id="period-start" class="form-input">
                            </div>
                            <div>
                                <label for="period-end" class="form-label">Fin de période</label>
                                <input type="date" id="period-end" class="form-input">
                            </div>
                        </div>
                         <div>
                            <label for="rent-amount" class="form-label">Montant du Loyer (€)</label>
                            <input type="number" id="rent-amount" class="form-input" value="448.85" step="0.01">
                        </div>
                        <div>
                            <label for="charges-amount" class="form-label">Montant des Charges (€)</label>
                            <input type="number" id="charges-amount" class="form-input" value="91.00" step="0.01">
                        </div>
                        <div>
                            <label for="total-amount" class="form-label">Total (€)</label>
                            <input type="text" id="total-amount" class="form-input bg-gray-100" readonly>
                        </div>
                         <div>
                            <label for="date-issued" class="form-label">Fait le</label>
                            <input type="date" id="date-issued" class="form-input">
                        </div>
                    </div>
                </div>

                <button id="print-btn" class="btn btn-primary w-full text-lg py-3 no-print">
                    Imprimer la Quittance (PDF)
                </button>
            </div>

            <!-- Colonne de droite : Prévisualisation -->
            <div class="lg:col-span-2">
                <div id="receipt-preview" class="bg-white p-8 md:p-12 shadow-2xl rounded-lg border border-gray-200 min-h-[1123px] max-w-[794px] mx-auto" style="width: 21cm; min-height: 29.7cm;">
                    
                    <div class="grid grid-cols-2 gap-10 mb-8">
                        <div>
                            <h3 class="text-sm font-semibold uppercase text-gray-500 mb-2">PROPRIÉTAIRE</h3>
                            <div class="font-medium text-gray-800">
                                <span id="preview-owner-name">René Osias ASSENDAHI</span>
                            </div>
                            <div class="text-gray-600">
                                <span id="preview-owner-phone">0668336085</span><br>
                                <span id="preview-owner-email">essonne1992@gmail.com</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold uppercase text-gray-500 mb-2">LOCATAIRE</h3>
                            <div class="font-medium text-gray-800">
                                <span id="preview-tenant-name">SOLIHA SEINE ET MARNE</span>
                            </div>
                            <div class="text-gray-600 whitespace-pre-line">
                                <span id="preview-tenant-address">76 rue dian fossey 77000 melun</span>
                            </div>
                        </div>
                    </div>

                    <h1 class="text-3xl font-bold text-center my-12 text-gray-900">QUITTANCE DE LOYER</h1>

                    <div class="text-right mb-8">
                        Période du <span id="preview-period-start" class="font-medium">01-04-2025</span> au <span id="preview-period-end" class="font-medium">30-04-2025</span>
                    </div>

                    <p class="text-gray-700 leading-relaxed mb-6">
                        Je soussigné, <span id="preview-owner-name-2" class="font-bold">René Osias ASSENDAHI</span>, propriétaire du logement situé au <span id="preview-property-address" class="font-bold whitespace-pre-line">76 rue dian fossey 77000 melun</span>, atteste avoir reçu, de la part de <span id="preview-tenant-name-2" class="font-bold">SOLIHA SEINE ET MARNE</span>, la somme de <span id="preview-total-words" class="font-bold">cinq cent trente-neuf Euros quatre-vingt-cinq centimes</span> se décomposant comme suit:
                    </p>

                    <table class="w-full my-8 border-collapse">
                        <thead>
                            <tr>
                                <th class="border p-3 text-left bg-gray-100 font-semibold text-gray-700">Description</th>
                                <th class="border p-3 text-right bg-gray-100 font-semibold text-gray-700">Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-3 text-gray-700">Montant du loyer</td>
                                <td class="border p-3 text-right text-gray-800" id="preview-rent-amount">448,85 €</td>
                            </tr>
                            <tr>
                                <td class="border p-3 text-gray-700">Charges</td>
                                <td class="border p-3 text-right text-gray-800" id="preview-charges-amount">91,00 €</td>
                            </tr>
                            <tr>
                                <td class="border p-3 text-left bg-gray-50 font-bold text-gray-900">TOTAL</td>
                                <td class="border p-3 text-right bg-gray-50 font-bold text-gray-900" id="preview-total-amount">539,85 €</td>
                            </tr>
                        </tbody>
                    </table>

                    <p class="text-gray-700 leading-relaxed mb-10">
                        Cette somme de <span id="preview-total-words-2" class="font-bold">cinq cent trente-neuf Euros quatre-vingt-cinq centimes</span>, correspond au règlement du loyer et des charges pour la période du <span id="preview-period-start-2" class="font-medium">01-04-2025</span> au <span id="preview-period-end-2" class="font-medium">30-04-2025</span>.
                    </p>
                    
                    <table class="w-full my-8 text-center text-sm">
                        <thead>
                            <tr>
                                <th class="border p-2 bg-gray-100 font-semibold text-gray-700">Montant à verser</th>
                                <th class="border p-2 bg-gray-100 font-semibold text-gray-700">Montant versé</th>
                                <th class="border p-2 bg-gray-100 font-semibold text-gray-700">Reste à percevoir</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2 text-gray-800" id="preview-total-due">539,85 €</td>
                                <td class="border p-2 text-gray-800" id="preview-total-paid">539,85 €</td>
                                <td class="border p-2 text-gray-800" id="preview-total-remaining">0,00 €</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="flex justify-between items-start mt-16">
                         <div>
                            Fait le <span id="preview-date-issued" class="font-medium">09-04-2025</span>
                        </div>
                        <div class="text-right">
                            <span id="preview-owner-name-3" class="font-bold">René Osias ASSENDAHI</span>
                        </div>
                    </div>

                    <div class="border-t mt-16 pt-4 text-xs text-gray-500 text-justify">
                        Le paiement de la présente n'emporte pas présomption de paiement des termes antérieurs. Cette quittance ou ce reçu annule tous les reçus qui auraient pu être donnés pour acompte versé sur le présent terme. En cas de congé précédemment donné, cette quittance ou ce reçu représenterait l'indemnité d'occupation et ne saurait être considéré comme un titre d'occupation. Sous réserve d'encaissement.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ÉLÉMENTS DU DOM ---
            // Sélecteurs
            const ownerSelect = document.getElementById('owner-select');
            const tenantSelect = document.getElementById('tenant-select');
            const propertySelect = document.getElementById('property-select');

            // Formulaires de gestion
            const ownerNameInput = document.getElementById('owner-name');
            const ownerPhoneInput = document.getElementById('owner-phone');
            const ownerEmailInput = document.getElementById('owner-email');
            const tenantNameInput = document.getElementById('tenant-name');
            const tenantAddressInput = document.getElementById('tenant-address');
            const propertyAddressInput = document.getElementById('property-address');

            // Formulaire de quittance
            const periodStartInput = document.getElementById('period-start');
            const periodEndInput = document.getElementById('period-end');
            const rentAmountInput = document.getElementById('rent-amount');
            const chargesAmountInput = document.getElementById('charges-amount');
            const totalAmountInput = document.getElementById('total-amount');
            const dateIssuedInput = document.getElementById('date-issued');

            // Boutons
            const saveOwnerBtn = document.getElementById('save-owner-btn');
            const deleteOwnerBtn = document.getElementById('delete-owner-btn');
            const saveTenantBtn = document.getElementById('save-tenant-btn');
            const deleteTenantBtn = document.getElementById('delete-tenant-btn');
            const savePropertyBtn = document.getElementById('save-property-btn');
            const deletePropertyBtn = document.getElementById('delete-property-btn');
            const printBtn = document.getElementById('print-btn');

            // Champs de la prévisualisation
            const preview = {
                ownerName: document.getElementById('preview-owner-name'),
                ownerPhone: document.getElementById('preview-owner-phone'),
                ownerEmail: document.getElementById('preview-owner-email'),
                tenantName: document.getElementById('preview-tenant-name'),
                tenantAddress: document.getElementById('preview-tenant-address'),
                periodStart: document.getElementById('preview-period-start'),
                periodEnd: document.getElementById('preview-period-end'),
                ownerName2: document.getElementById('preview-owner-name-2'),
                propertyAddress: document.getElementById('preview-property-address'),
                tenantName2: document.getElementById('preview-tenant-name-2'),
                totalWords: document.getElementById('preview-total-words'),
                rentAmount: document.getElementById('preview-rent-amount'),
                chargesAmount: document.getElementById('preview-charges-amount'),
                totalAmount: document.getElementById('preview-total-amount'),
                totalWords2: document.getElementById('preview-total-words-2'),
                periodStart2: document.getElementById('preview-period-start-2'),
                periodEnd2: document.getElementById('preview-period-end-2'),
                totalDue: document.getElementById('preview-total-due'),
                totalPaid: document.getElementById('preview-total-paid'),
                totalRemaining: document.getElementById('preview-total-remaining'),
                dateIssued: document.getElementById('preview-date-issued'),
                ownerName3: document.getElementById('preview-owner-name-3'),
            };

            // --- GESTION DU STOCKAGE LOCAL ---
            
            /**
             * Charge les données depuis localStorage
             * @param {string} key - Clé de stockage (e.g., 'owners')
             * @returns {Array} - Tableau de données
             */
            const loadFromStorage = (key) => {
                return JSON.parse(localStorage.getItem(key)) || [];
            };

            /**
             * Sauvegarde les données dans localStorage
             * @param {string} key - Clé de stockage
             * @param {Array} data - Tableau de données
             */
            const saveToStorage = (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            };

            /**
             * Remplit un <select> avec les données
             * @param {HTMLSelectElement} selectEl - L'élément <select>
             * @param {Array} data - Tableau d'objets
             * @param {string} nameField - Clé à utiliser pour l'affichage (e.g., 'name' ou 'address')
             */
            const populateSelect = (selectEl, data, nameField) => {
                selectEl.innerHTML = '';
                if (data.length === 0) {
                    selectEl.innerHTML = '<option value="">-- Ajoutez un élément --</option>';
                    return;
                }
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item[nameField];
                    selectEl.appendChild(option);
                });
            };

            // --- FONCTIONS DE GESTION (CRUD) ---

            // Propriétaires
            const refreshOwners = () => {
                const owners = loadFromStorage('owners');
                populateSelect(ownerSelect, owners, 'name');
                if (owners.length > 0) {
                    loadOwnerData(owners[0].id);
                }
                updatePreview();
            };

            const loadOwnerData = (id) => {
                const owners = loadFromStorage('owners');
                const owner = owners.find(o => o.id === id);
                if (owner) {
                    ownerNameInput.value = owner.name;
                    ownerPhoneInput.value = owner.phone;
                    ownerEmailInput.value = owner.email;
                }
            };

            saveOwnerBtn.addEventListener('click', () => {
                let owners = loadFromStorage('owners');
                const selectedId = ownerSelect.value;
                const existingOwner = owners.find(o => o.id === selectedId);

                const ownerData = {
                    id: existingOwner ? selectedId : crypto.randomUUID(),
                    name: ownerNameInput.value,
                    phone: ownerPhoneInput.value,
                    email: ownerEmailInput.value,
                };

                if (existingOwner) {
                    // Mise à jour
                    owners = owners.map(o => o.id === selectedId ? ownerData : o);
                } else {
                    // Ajout
                    owners.push(ownerData);
                }
                
                saveToStorage('owners', owners);
                refreshOwners();
                ownerSelect.value = ownerData.id; // Sélectionne l'élément sauvegardé
            });

            deleteOwnerBtn.addEventListener('click', () => {
                let owners = loadFromStorage('owners');
                const selectedId = ownerSelect.value;
                if (!selectedId || !confirm("Voulez-vous vraiment supprimer ce propriétaire ?")) return;
                
                owners = owners.filter(o => o.id !== selectedId);
                saveToStorage('owners', owners);
                
                // Vider les champs si le propriétaire supprimé était le dernier
                if (owners.length === 0) {
                     ownerNameInput.value = '';
                     ownerPhoneInput.value = '';
                     ownerEmailInput.value = '';
                }
                refreshOwners();
            });

            ownerSelect.addEventListener('change', () => {
                loadOwnerData(ownerSelect.value);
                updatePreview();
            });

            // Locataires
            const refreshTenants = () => {
                const tenants = loadFromStorage('tenants');
                populateSelect(tenantSelect, tenants, 'name');
                 if (tenants.length > 0) {
                    loadTenantData(tenants[0].id);
                }
                updatePreview();
            };

            const loadTenantData = (id) => {
                const tenants = loadFromStorage('tenants');
                const tenant = tenants.find(t => t.id === id);
                if (tenant) {
                    tenantNameInput.value = tenant.name;
                    tenantAddressInput.value = tenant.address;
                }
            };

            saveTenantBtn.addEventListener('click', () => {
                let tenants = loadFromStorage('tenants');
                const selectedId = tenantSelect.value;
                const existingTenant = tenants.find(t => t.id === selectedId);

                const tenantData = {
                    id: existingTenant ? selectedId : crypto.randomUUID(),
                    name: tenantNameInput.value,
                    address: tenantAddressInput.value,
                };

                if (existingTenant) {
                    tenants = tenants.map(t => t.id === selectedId ? tenantData : t);
                } else {
                    tenants.push(tenantData);
                }
                
                saveToStorage('tenants', tenants);
                refreshTenants();
                tenantSelect.value = tenantData.id;
            });

            deleteTenantBtn.addEventListener('click', () => {
                let tenants = loadFromStorage('tenants');
                const selectedId = tenantSelect.value;
                if (!selectedId || !confirm("Voulez-vous vraiment supprimer ce locataire ?")) return;
                
                tenants = tenants.filter(t => t.id !== selectedId);
                saveToStorage('tenants', tenants);

                if (tenants.length === 0) {
                    tenantNameInput.value = '';
                    tenantAddressInput.value = '';
                }
                refreshTenants();
            });

            tenantSelect.addEventListener('change', () => {
                loadTenantData(tenantSelect.value);
                updatePreview();
            });

            // Biens
            const refreshProperties = () => {
                const properties = loadFromStorage('properties');
                populateSelect(propertySelect, properties, 'address');
                 if (properties.length > 0) {
                    loadPropertyData(properties[0].id);
                }
                updatePreview();
            };

            const loadPropertyData = (id) => {
                const properties = loadFromStorage('properties');
                const property = properties.find(p => p.id === id);
                if (property) {
                    propertyAddressInput.value = property.address;
                }
            };

            savePropertyBtn.addEventListener('click', () => {
                let properties = loadFromStorage('properties');
                const selectedId = propertySelect.value;
                const existingProperty = properties.find(p => p.id === selectedId);

                const propertyData = {
                    id: existingProperty ? selectedId : crypto.randomUUID(),
                    address: propertyAddressInput.value,
                };

                if (existingProperty) {
                    properties = properties.map(p => p.id === selectedId ? propertyData : p);
                } else {
                    properties.push(propertyData);
                }
                
                saveToStorage('properties', properties);
                refreshProperties();
                propertySelect.value = propertyData.id;
            });
            
            deletePropertyBtn.addEventListener('click', () => {
                let properties = loadFromStorage('properties');
                const selectedId = propertySelect.value;
                if (!selectedId || !confirm("Voulez-vous vraiment supprimer ce bien ?")) return;
                
                properties = properties.filter(p => p.id !== selectedId);
                saveToStorage('properties', properties);

                if (properties.length === 0) {
                    propertyAddressInput.value = '';
                }
                refreshProperties();
            });

            propertySelect.addEventListener('change', () => {
                loadPropertyData(propertySelect.value);
                updatePreview();
            });

            // --- FONCTION DE MISE À JOUR DE LA QUITTANCE ---

            const updatePreview = () => {
                // Formats
                const formatCurrency = (num) => isNaN(num) ? '0,00 €' : num.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'jj-mm-aaaa';
                    const [year, month, day] = dateStr.split('-');
                    return `${day}-${month}-${year}`;
                };
                
                // Calculs
                const rent = parseFloat(rentAmountInput.value) || 0;
                const charges = parseFloat(chargesAmountInput.value) || 0;
                const total = rent + charges;
                totalAmountInput.value = total.toFixed(2);
                
                const totalInWords = numberToFrenchWords(total);

                // Mise à jour de la prévisualisation
                preview.ownerName.textContent = ownerNameInput.value;
                preview.ownerName2.textContent = ownerNameInput.value;
                preview.ownerName3.textContent = ownerNameInput.value;
                preview.ownerPhone.textContent = ownerPhoneInput.value;
                preview.ownerEmail.textContent = ownerEmailInput.value;

                preview.tenantName.textContent = tenantNameInput.value;
                preview.tenantName2.textContent = tenantNameInput.value;
                preview.tenantAddress.textContent = tenantAddressInput.value;

                preview.propertyAddress.textContent = propertyAddressInput.value;

                preview.periodStart.textContent = formatDate(periodStartInput.value);
                preview.periodEnd.textContent = formatDate(periodEndInput.value);
                preview.periodStart2.textContent = formatDate(periodStartInput.value);
                preview.periodEnd2.textContent = formatDate(periodEndInput.value);

                preview.rentAmount.textContent = formatCurrency(rent);
                preview.chargesAmount.textContent = formatCurrency(charges);
                preview.totalAmount.textContent = formatCurrency(total);
                
                preview.totalDue.textContent = formatCurrency(total);
                preview.totalPaid.textContent = formatCurrency(total);
                preview.totalRemaining.textContent = formatCurrency(0);

                preview.totalWords.textContent = totalInWords;
                preview.totalWords2.textContent = totalInWords;
                
                preview.dateIssued.textContent = formatDate(dateIssuedInput.value);
            };

            // --- FONCTION DE CONVERSION NOMBRE EN LETTRES ---
            // (Adaptation simplifiée pour les montants de loyer)
            const numberToFrenchWords = (number) => {
                const parts = parseFloat(number).toFixed(2).split('.');
                const euros = parseInt(parts[0], 10);
                const centimes = parseInt(parts[1], 10);

                let words = `${convert(euros)} Euro${euros > 1 ? 's' : ''}`;
                if (centimes > 0) {
                    words += ` ${convert(centimes)} centime${centimes > 1 ? 's' : ''}`;
                }
                return words.charAt(0).toUpperCase() + words.slice(1);
            };

            const convert = (num) => {
                if (num === 0) return 'zéro';
                
                const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
                const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
                const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];

                let str = '';
                
                const processPart = (n) => {
                    let part = '';
                    if (n >= 100) {
                        let hundreds = Math.floor(n / 100);
                        part += (hundreds > 1 ? units[hundreds] + ' ' : '') + 'cent' + (hundreds > 1 && (n % 100 === 0) ? 's' : '');
                        n %= 100;
                        if(n > 0) part += ' ';
                    }
                    
                    if (n >= 10 && n <= 19) {
                        part += teens[n - 10];
                    } else if (n >= 20) {
                        let ten = Math.floor(n / 10);
                        part += tens[ten];
                        n %= 10;
                        if (n > 0) {
                             if(ten === 7 || ten === 9) { // soixante-onze, quatre-vingt-onze
                                part = tens[ten-1] + '-' + teens[n];
                             } else if (ten === 8 && n > 0) { // quatre-vingt-un
                                part += '-' + units[n];
                             } else if (n === 1 && ten < 8) { // vingt-et-un
                                part += '-et-' + units[n];
                             } else {
                                part += '-' + units[n];
                             }
                        } else {
                            if(ten === 8) part += 's'; // quatre-vingts
                        }
                    } else if (n > 0) {
                        part += units[n];
                    }
                    return part;
                }

                if (num >= 1000) {
                    let thousands = Math.floor(num / 1000);
                    str += (thousands > 1 ? processPart(thousands) + ' ' : '') + 'mille';
                    num %= 1000;
                    if(num > 0) str += ' ';
                }
                
                str += processPart(num);
                
                // Nettoyage final
                return str.replace(/-et-un/g, '-et-un').trim();
            };

            // --- INITIALISATION ---

            // Définir les dates par défaut
            const today = new Date();
            dateIssuedInput.valueAsDate = today;
            
            // Période du mois en cours
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            periodStartInput.valueAsDate = firstDay;
            periodEndInput.valueAsDate = lastDay;

            // Charger les données initiales
            refreshOwners();
            refreshTenants();
            refreshProperties();
            
            // Si c'est la première visite, charger les données de l'exemple
            if (loadFromStorage('owners').length === 0) {
                console.log('Première visite, chargement des données exemples.');
                saveOwnerBtn.click();
                saveTenantBtn.click();
                savePropertyBtn.click();
            }

            // Mettre à jour la prévisualisation une première fois
            updatePreview();

            // Ajouter les écouteurs d'événements pour la mise à jour en direct
            const allInputs = document.querySelectorAll('.form-input, .form-select');
            allInputs.forEach(input => {
                input.addEventListener('input', updatePreview);
                input.addEventListener('change', updatePreview);
            });

            // Écouteur pour l'impression
            printBtn.addEventListener('click', () => {
                window.print();
            });
        });
    </script>
</body>
</html>
