<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Quittance Multi-Propriété</title>
    <!-- Chargement de Tailwind CSS pour un design responsive et moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de Chart.js pour la visualisation des données -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Styles de base pour l'esthétique et la réactivité */
        body { font-family: 'Inter', sans-serif; background-color: #e5e7eb; } 
        
        /* Amélioration du style des inputs */
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem;
            appearance: none; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: #3b82f6; /* Bleu plus vif */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        
        /* Nouveau style de carte avec ombre plus douce */
        .card { 
            background-color: white;             border-radius: 1rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Ombre plus douce */
            padding: 2rem; 
        }

        /* Styles des boutons améliorés */
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.6rem; 
            font-weight: 600; 
            text-align: center; 
            cursor: pointer; 
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
        }
        .btn:active { transform: translateY(1px); }

        /* Palette de couleurs basée sur le bleu (primary: 600) et le vert (success: 500) */
        .btn-primary { 
            background-color: #3b82f6; 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); 
        }
        .btn-primary:hover { background-color: #2563eb; }

        .btn-green { /* Nouveau bien */
            background-color: #10b981;
            color: white;
        }
        .btn-green:hover { background-color: #059669; }

        .btn-yellow { /* Enregistrer */
            background-color: #f59e0b;
            color: white;
        }
        .btn-yellow:hover { background-color: #d97706; }

        .btn-red { /* Supprimer */
            background-color: #ef4444;
            color: white;
        }
        .btn-red:hover { background-color: #dc2626; }

        .btn-mail { /* Envoyer Email */
            background-color: #4f46e5; /* Indigo */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4);
        }
        .btn-mail:hover { background-color: #4338ca; }
        
        /* Conteneur pour le graphique */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
        }

        /* Style pour les notifications Toast */
        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
        }
        .toast {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            animation: fadeInOut 5s ease-in-out forwards;
        }
        .toast-success { background-color: #10b981; color: white; }
        .toast-error { background-color: #ef4444; color: white; }
        .toast-info { background-color: #3b82f6; color: white; }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(100%); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(100%); }
        }

        /* Styles d'impression : Masque les outils pour imprimer uniquement la quittance */
        @media print {
            body * { visibility: hidden; }
            #quittance-preview, #quittance-preview * { visibility: visible; }
            #quittance-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10 no-print">
            <h1 class="text-3xl font-bold text-gray-900">Générateur de Quittance Multi-Propriété</h1>
            <p class="text-gray-600 mt-1">Gérez vos biens et générez des quittances personnalisées. (Sauvegarde Cloud via Firestore)</p>
             <p id="user-info" class="text-xs mt-2 text-gray-500">
                <span id="loading-spinner" class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-b-transparent border-blue-500 mr-2"></span>
                Connexion au Cloud...
             </p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- VOLET GAUCHE : FORMULAIRE D'ÉDITION -->
            <div class="space-y-8 no-print" id="input-controls">
                
                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-700">Sélection & Gestion de la Propriété</h2>
                    <label for="property-selector" class="form-label">Propriété :</label>
                    <select id="property-selector" class="form-select mb-4" disabled>
                        <option value="-1">Chargement des données...</option>
                    </select>

                    <div class="grid grid-cols-3 gap-3">
                        <button id="add-new-btn" class="btn btn-green">Nouveau Bien</button>
                        <button id="save-btn" class="btn btn-yellow">Enregistrer les Modifs</button>
                        <button id="delete-btn" class="btn btn-red" disabled>Supprimer ce Bien</button>
                    </div>
                </section>

                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-700">Paramètres de la Quittance</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="periode" class="form-label">Période (Mois/Année)</label>
                            <input type="month" id="periode" class="form-input" value="2025-09">
                        </div>
                        <div>
                            <label for="date-emission" class="form-label">Date d'émission</label>
                            <input type="date" id="date-emission" class="form-input">
                        </div>
                        <div>
                            <label for="loyer" class="form-label">Loyer Hors Charges (€)</label>
                            <input type="number" id="loyer" class="form-input" value="448.85" step="0.01">
                        </div>
                        <div>
                            <label for="charges" class="form-label">Charges (€)</label>
                            <input type="number" id="charges" class="form-input" value="91.00" step="0.01">
                        </div>
                    </div>
                </section>

                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-700">Informations des Parties</h2>
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700">Propriétaire (Bailleur)</h3>
                        <input type="text" id="prop-nom" class="form-input" placeholder="Nom du Propriétaire" value="René Osias ASSENDAHI">
                        <input type="text" id="prop-contact" class="form-input" placeholder="Contact Propriétaire (Tél/Email)" value="0668336085 / essonne1992@gmail.com">
                    </div>
                    <div class="space-y-4 mt-6">
                        <h3 class="font-semibold text-gray-700">Locataire</h3>
                        <input type="text" id="loc-nom" class="form-input" placeholder="Nom du Locataire" value="SOLIHA SEINE ET MARNE">
                        <input type="text" id="loc-adresse" class="form-input" placeholder="Adresse du Logement" value="76 rue dian fossey 77000 melun">
                        <input type="email" id="loc-email" class="form-input" placeholder="Adresse E-mail du Locataire" value="soliha@example.com">
                        <input type="tel" id="loc-tel" class="form-input" placeholder="Numéro de téléphone du Locataire" value="06 12 34 56 78">
                    </div>
                </section>
                
                <!-- Section de visualisation (Graphique de Loyer/Charges) -->
                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-700">Composition du Loyer</h2>
                    <div class="chart-container">
                        <canvas id="repartitionChart"></canvas>
                    </div>
                </section>
            </div>

            <!-- VOLET DROIT : APERÇU DE LA QUITTANCE IMPRIMABLE -->
            <div>
                <section id="quittance-preview" class="card quittance-preview flex flex-col p-8 md:p-12 border-4 border-blue-100 min-h-[600px]">
                    
                    <div class="text-right text-sm text-gray-500 mb-6">
                        <p id="preview-prop-contact-small"></p>
                    </div>

                    <h2 class="text-3xl font-extrabold text-center mb-10 text-blue-800 border-b-4 border-blue-500 pb-2">QUITTANCE DE LOYER</h2>

                    <!-- Bloc infos (Propriétaire/Locataire) -->
                    <div class="grid grid-cols-2 gap-8 mb-8 text-sm">
                        <div class="p-3 border rounded-lg bg-blue-50">
                            <h3 class="font-bold text-blue-800 pb-1 mb-2">BAILLEUR (PROPRIÉTAIRE)</h3>
                            <p id="preview-prop-nom" class="font-medium text-lg"></p>
                            <p id="preview-prop-contact" class="text-gray-600"></p>
                        </div>
                        <div class="p-3 border rounded-lg bg-yellow-50">
                            <h3 class="font-bold text-yellow-800 pb-1 mb-2">LOCATAIRE</h3>
                            <p id="preview-loc-nom" class="font-medium text-lg"></p>
                            <p id="preview-loc-email" class="text-gray-600"></p>
                            <p id="preview-loc-tel" class="text-gray-600"></p>
                        </div>
                    </div>

                    <div class="mb-8 p-4 bg-gray-100 rounded-lg">
                        <p class="text-lg"><strong>Logement situé au :</strong> <span id="preview-loc-adresse" class="font-bold text-blue-700"></span></p>
                        <p class="text-lg mt-1"><strong>Période concernée :</strong> <span id="preview-periode" class="font-bold"></span></p>
                    </div>

                    <!-- Texte principal avec le total en toutes lettres -->
                    <p class="mb-6 leading-relaxed">
                        Je soussigné, <strong id="preview-prop-nom-text"></strong>, propriétaire du logement ci-dessus désigné,
                        atteste avoir reçu, de la part de <strong id="preview-loc-nom-text"></strong>,
                        la somme totale de <strong id="preview-total-text" class="text-red-600"></strong>,
                        correspondant au paiement du loyer et des charges pour la période ci-dessus mentionnée.
                        Cette somme se décompose comme suit :
                    </p>

                    <!-- Tableau des montants -->
                    <table class="w-full mb-8 border border-blue-400 rounded-lg overflow-hidden">
                        <thead class="bg-blue-600 text-white">
                            <tr>
                                <th class="text-left p-3 font-semibold">Désignation</th>
                                <th class="text-right p-3 font-semibold">Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t hover:bg-gray-50">
                                <td class="p-3">Loyer Hors Charges</td>
                                <td id="preview-loyer" class="text-right p-3 font-mono"></td>
                            </tr>
                            <tr class="border-t hover:bg-gray-50">
                                <td class="p-3">Provisions pour Charges</td>
                                <td id="preview-charges" class="text-right p-3 font-mono"></td>
                            </tr>
                            <tr class="border-t bg-blue-100 text-blue-900 font-extrabold text-xl">
                                <td class="p-3">TOTAL PAYÉ</td>
                                <td id="preview-total" class="text-right p-3 font-mono"></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Signature et date -->
                    <div class="text-right mt-auto">
                        <p class="mb-4 text-lg font-medium">Fait à (à compléter), le <span id="preview-date-emission" class="font-bold"></span>.</p>
                        <div class="mt-8">
                            <p class="font-semibold text-lg border-t pt-2 inline-block px-8 border-gray-400" id="preview-signature">Le Propriétaire</p>
                        </div>
                    </div>
                    <!-- Mentions légales (du modèle PDF) -->
                    <div class="text-xs text-gray-500 mt-12 pt-4 border-t">
                        <p>Le paiement de la présente n'emporte pas présomption de paiement des termes antérieurs. Cette quittance ou ce reçu annule tous les reçus qui auraient pu être donnés pour acompte versé sur le présent terme. En cas de congé précédemment donné, cette quittance ou ce reçu représenterait l'indemnité d'occupation et ne saurait être considéré comme un titre d'occupation. Sous réserve d'encaissement. Le bailleur certifie que le logement est libre de toute dette de loyer et de charges pour la période concernée.</p>
                    </div>
                </section>
                
                <div class="card text-center mt-4 no-print grid grid-cols-2 gap-4">
                    <button id="email-btn" class="btn btn-mail w-full">Envoyer par E-mail (Pré-rempli)</button>
                    <button id="print-btn" class="btn btn-primary w-full">Imprimer/Générer PDF</button>
                </div>
                <div id="email-instruction" class="card text-sm p-3 mt-4 text-center text-gray-600 hidden no-print">
                    ⚠️ **Étape manuelle requise :** Le PDF ne peut pas être joint automatiquement. N'oubliez pas d'utiliser le bouton **"Imprimer/Générer PDF"** (choisir 'Enregistrer en PDF') puis de glisser-déposer le fichier PDF dans l'e-mail pré-rempli.
                </div>
            </div>
        </main>
    </div>
    
    <!-- Conteneur pour les notifications toast -->
    <div id="toast-container"></div>

    <!-- FIREBASE MODULE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales pour Firebase et l'état de l'application
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let propertiesData = []; // Données des propriétés (vient de Firestore)
        let chartInitialized = false;

        // Récupération des variables d'environnement (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Récupération des éléments HTML (Inputs et Zones d'affichage)
        const inputs = {
            propertySelector: document.getElementById('property-selector'),
            periode: document.getElementById('periode'),
            dateEmission: document.getElementById('date-emission'),
            loyer: document.getElementById('loyer'),
            charges: document.getElementById('charges'),
            propNom: document.getElementById('prop-nom'),
            propContact: document.getElementById('prop-contact'),
            locNom: document.getElementById('loc-nom'),
            locAdresse: document.getElementById('loc-adresse'),
            locEmail: document.getElementById('loc-email'), 
            locTel: document.getElementById('loc-tel'), 
            saveBtn: document.getElementById('save-btn'),
            addNewBtn: document.getElementById('add-new-btn'),
            deleteBtn: document.getElementById('delete-btn'), 
            emailBtn: document.getElementById('email-btn'),
            emailInstruction: document.getElementById('email-instruction'),
            userInfo: document.getElementById('user-info'),
            loadingSpinner: document.getElementById('loading-spinner'),
        };

        const previews = {
            propNom: document.getElementById('preview-prop-nom'),
            propContact: document.getElementById('preview-prop-contact'),
            propContactSmall: document.getElementById('preview-prop-contact-small'),
            locNom: document.getElementById('preview-loc-nom'),
            locAdresse: document.getElementById('preview-loc-adresse'),
            locEmail: document.getElementById('preview-loc-email'), 
            locTel: document.getElementById('preview-loc-tel'), 
            periode: document.getElementById('preview-periode'),
            propNomText: document.getElementById('preview-prop-nom-text'),
            locAdresseText: document.getElementById('preview-loc-adresse-text'),
            locNomText: document.getElementById('preview-loc-nom-text'),
            totalText: document.getElementById('preview-total-text'),
            loyer: document.getElementById('preview-loyer'),
            charges: document.getElementById('preview-charges'),
            total: document.getElementById('preview-total'),
            dateEmission: document.getElementById('preview-date-emission'),
            signature: document.getElementById('preview-signature'),
        };

        let repartitionChart;

        // --- NOUVEAU: FONCTION UTILITAIRE DEBOUCE (Performance) ---

        /**
         * Retourne une fonction qui ne sera exécutée qu'après 'delay' ms après son dernier appel.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // --- NOUVEAU: SYSTÈME DE NOTIFICATION TOAST (UX) ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000); // Le toast disparaît après 5 secondes (légèrement plus court que l'animation)
        }


        // --- FIREBASE & AUTHENTIFICATION ---

        function getCollectionPath() {
            if (!userId) {
                console.error("User ID is not set. Cannot form collection path.");
                return null;
            }
            // Chemin de la collection privée : /artifacts/{appId}/users/{userId}/properties
            return collection(db, 'artifacts', appId, 'users', userId, 'properties');
        }

        async function initFirebaseAndAuth() {
            try {
                // CORRECTION: Vérifier la configuration Firebase avant de l'initialiser
                if (!firebaseConfig) {
                    inputs.userInfo.innerHTML = `<span class="text-red-500 font-bold">Erreur : Configuration Cloud absente. (firebaseConfig est null)</span>`;
                    inputs.loadingSpinner.classList.add('hidden');
                    showToast("Erreur critique : La configuration Cloud est manquante.", 'error');
                    return; // Arrêter l'initialisation si la configuration est absente
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Authentification
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Écouteur de l'état d'authentification
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        inputs.userInfo.innerHTML = `Utilisateur ID: <span class="font-mono text-gray-700">${userId}</span>`;
                        inputs.loadingSpinner.classList.add('hidden');
                        isAuthReady = true;
                        subscribeToProperties();
                        showToast("Connexion Cloud réussie.", 'success');
                    } else {
                        inputs.userInfo.textContent = "Déconnecté. Veuillez recharger si le problème persiste.";
                    }
                });

            } catch (error) {
                console.error("Erreur d'initialisation de Firebase ou d'authentification:", error);
                inputs.userInfo.innerHTML = `<span class="text-red-500">Erreur de connexion au Cloud. (Détails en console)</span>`;
                inputs.propertySelector.innerHTML = '<option value="-1">Erreur de chargement</option>';
                showToast("Erreur lors de la connexion Cloud. Veuillez vérifier votre connexion.", 'error');
            }
        }

        // --- GESTION DES DONNÉES FIRESTORE (CRUD via onSnapshot) ---

        function subscribeToProperties() {
            const propertiesCol = getCollectionPath();
            if (!propertiesCol) return;

            onSnapshot(query(propertiesCol), (snapshot) => {
                const newPropertiesData = [];
                snapshot.forEach(doc => {
                    newPropertiesData.push({
                        ...doc.data(),
                        id: doc.id,
                    });
                });
                
                propertiesData = newPropertiesData;
                
                // Conserver la sélection actuelle si elle existe encore après la mise à jour
                const previousIndex = parseInt(inputs.propertySelector.value);
                let newIndex = 0; // Par défaut, on sélectionne le premier

                if (propertiesData.length > 0) {
                     // Si l'ancienne propriété existe toujours dans la liste, on la resélectionne
                     const oldId = propertiesData[previousIndex]?.id;
                     const foundIndex = propertiesData.findIndex(p => p.id === oldId);
                     newIndex = foundIndex !== -1 ? foundIndex : 0; 
                }

                populatePropertySelector(newIndex);
                inputs.propertySelector.disabled = false;

                if (propertiesData.length === 0) {
                    showToast("Veuillez ajouter votre première propriété.", 'info');
                }
                
            }, (error) => {
                console.error("Erreur de récupération des données en temps réel:", error);
                showToast("Erreur de synchronisation des propriétés.", 'error');
            });
        }

        async function savePropertyData() {
            if (!isAuthReady) {
                showToast("Veuillez attendre la connexion au service de sauvegarde.", 'error');
                return;
            }

            const selectedIndex = parseInt(inputs.propertySelector.value);
            
            if (inputs.locNom.value === "" || inputs.locAdresse.value === "") {
                showToast("Veuillez remplir au moins le Nom du Locataire et l'Adresse.", 'error');
                return;
            }

            const propertyData = {
                locataire: inputs.locNom.value,
                email: inputs.locEmail.value,
                telephone: inputs.locTel.value,
                adresse: inputs.locAdresse.value,
                // Assurer que les nombres sont stockés comme des nombres (et non des strings)
                loyer_hc: parseFloat(inputs.loyer.value) || 0,
                charges: parseFloat(inputs.charges.value) || 0,
                updatedAt: serverTimestamp(),
            };

            try {
                if (selectedIndex !== -1 && selectedIndex < propertiesData.length) {
                    // MISE À JOUR d'un bien existant
                    const propToUpdate = propertiesData[selectedIndex];
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'properties', propToUpdate.id);
                    await setDoc(docRef, propertyData, { merge: true }); 
                    showToast("Bien mis à jour avec succès !", 'success');
                } else {
                    // AJOUT d'un nouveau bien
                    const propertiesCol = getCollectionPath();
                    await addDoc(propertiesCol, propertyData);
                    showToast("Nouveau bien ajouté avec succès !", 'success');
                    // L'onSnapshot gérera la sélection du nouveau bien
                }
            } catch (e) {
                console.error("Erreur lors de la sauvegarde du bien:", e);
                showToast("Échec de l'enregistrement. (Erreur technique)", 'error');
            }
        }

        async function deleteSelectedProperty() {
            if (!isAuthReady || propertiesData.length === 0) return;

            const selectedIndex = parseInt(inputs.propertySelector.value);
            if (selectedIndex === -1 || selectedIndex >= propertiesData.length) {
                showToast("Aucun bien sélectionné à supprimer.", 'info');
                return;
            }

            // Nous allons utiliser un toast pour simuler la confirmation
            const propName = propertiesData[selectedIndex].locataire;
            showToast(`Suppression de ${propName}...`, 'info'); 

            const propToDelete = propertiesData[selectedIndex];

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'properties', propToDelete.id);
                await deleteDoc(docRef);
                showToast("Bien supprimé avec succès.", 'success');
            } catch (e) {
                console.error("Erreur lors de la suppression du bien:", e);
                showToast("Échec de la suppression. (Erreur technique)", 'error');
            }
        }
        
        // --- GESTION DE L'UI ---

        function populatePropertySelector(selectedIndex = 0) {
            inputs.propertySelector.innerHTML = '';
            
            if (propertiesData.length === 0) {
                 const option = document.createElement('option');
                 option.value = -1;
                 option.textContent = "--- Ajouter une propriété ---";
                 inputs.propertySelector.appendChild(option);
                 clearForm(false); 
                 inputs.deleteBtn.disabled = true;
                 return;
            }

            propertiesData.forEach((prop, index) => {
                const option = document.createElement('option');
                option.value = index; 
                option.textContent = `${prop.locataire} - ${prop.adresse.substring(0, 30)}...`; 
                inputs.propertySelector.appendChild(option);
            });
            
            inputs.propertySelector.value = Math.min(selectedIndex, propertiesData.length - 1); 
            loadPropertyData(inputs.propertySelector.value);
            inputs.deleteBtn.disabled = false;
        }

        function loadPropertyData(index) {
            const prop = propertiesData[index];

            if (prop) {
                inputs.locNom.value = prop.locataire || '';
                inputs.locAdresse.value = prop.adresse || '';
                inputs.locEmail.value = prop.email || '';
                inputs.locTel.value = prop.telephone || '';
                // Utiliser prop.loyer_hc pour s'assurer que c'est le format stocké
                inputs.loyer.value = prop.loyer_hc ? prop.loyer_hc.toFixed(2) : '0.00';
                inputs.charges.value = prop.charges ? prop.charges.toFixed(2) : '0.00';
            }
            updatePreview();
        }
        
        function clearForm(shouldResetDates = true) {
            inputs.locNom.value = "";
            inputs.locAdresse.value = "";
            inputs.locEmail.value = "";
            inputs.locTel.value = "";
            inputs.loyer.value = "0.00";
            inputs.charges.value = "0.00";
            if (shouldResetDates) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                inputs.dateEmission.value = `${yyyy}-${mm}-${dd}`;
            }

            inputs.propertySelector.value = -1; 
            showToast("Prêt à ajouter un nouveau bien.", 'info');
            inputs.deleteBtn.disabled = true;
            updatePreview();
        }
        
        function sendQuittanceEmail() {
            const locataireEmail = inputs.locEmail.value;
            const locataireName = inputs.locNom.value;
            const periode = previews.periode.textContent; 
            const total = previews.total.textContent;
            
            if (!locataireEmail || !locataireEmail.includes('@')) {
                showToast("L'adresse e-mail du locataire est manquante ou invalide.", 'error');
                return;
            }

            const subject = `[Quittance] Votre Quittance de Loyer pour la période ${periode}`;
            const body = `Bonjour ${locataireName},\n\nVeuillez trouver ci-joint votre quittance de loyer d'un montant total de ${total} pour la période ${periode}.\n\nCeci est un document officiel. Veuillez imprimer ou conserver ce PDF.\n\nCordialement,\n${inputs.propNom.value}`;

            const mailtoLink = `mailto:${locataireEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            inputs.emailInstruction.classList.remove('hidden');
            
            window.location.href = mailtoLink;
        }

        // Fonction de conversion de nombre à toutes lettres (Français)
        function numberToWordsFrench(n) {
            if (n === 0) return 'Zéro Euro';
            const s = n.toFixed(2).toString();
            let part = s.split('.');
            let euros = parseInt(part[0]);
            let centimes = parseInt(part[1]);

            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];

            function convert(num) {
                if (num === 0) return '';
                if (num < 10) return units[num];
                if (num < 20) return teens[num - 10];
                if (num < 70) {
                    let ten = Math.floor(num / 10);
                    let unit = num % 10;
                    if (ten === 6) { return 'soixante' + (unit > 0 ? ('-' + convert(num - 60)) : ''); }
                    let res = tens[ten] + (unit > 0 ? (unit === 1 && ten === 7 || ten === 9 ? '-et-' : '-') + convert(unit) : '');
                    return res.replace(/-$/, ''); 
                }
                if (num < 80) { return 'soixante-' + convert(num - 60); }
                if (num < 90) { return 'quatre-vingt' + (num > 80 ? ('-' + convert(num - 80)) : (num === 80 ? '' : '')); }
                if (num < 100) { return 'quatre-vingt-dix-' + convert(num - 90); }
                if (num < 200) { return 'cent' + (num > 100 ? ' ' + convert(num - 100) : ''); }
                if (num < 1000) {
                    let cent = Math.floor(num / 100);
                    let reste = num % 100;
                    let res = (cent === 1 ? 'cent' : units[cent] + ' cents');
                    if (cent > 1 && reste === 0) res = units[cent] + ' cents'; else if (cent > 1 && reste > 0) res = units[cent] + ' cent'; else if (cent === 1 && reste > 0) res = 'cent'; else if (cent === 1 && reste === 0) res = 'cent';
                    return (cent > 0 && reste > 0 ? res + ' ' : (cent > 0 && reste === 0 ? res : '')) + convert(reste);
                }
                if (num < 1000000) {
                    let mille = Math.floor(num / 1000);
                    let reste = num % 1000;
                    let res = (mille === 1 ? 'mille' : convert(mille) + ' mille');
                    return res + (reste > 0 ? ' ' + convert(reste) : '');
                }
                return '';
            }
            
            let euroText = convert(euros).trim().replace(' cents', ' cent');
            if (euros > 0 && euros < 200 && euroText.endsWith(' cent')) euroText = euroText.slice(0, -5) + (euros === 100 ? ' cent' : ' cent');
            if (euros > 1 && euroText.endsWith('cent')) euroText += 's';

            let centimeText = '';
            if (centimes > 0) {
                 if (centimes < 10 && centimes > 0) centimes = centimes * 10;
                 let centimeWord = convert(centimes).trim();
                 centimeText = centimes === 1 ? ' et un centime' : ' et ' + centimeWord + ' centimes';
            }

            let result = euroText + (euros > 1 ? ' Euros' : ' Euro') + centimeText;
            return result.charAt(0).toUpperCase() + result.slice(1).replace(/\s+/g, ' ');
        }
        
        // NOUVEAU: Fonction d'affectation sécurisée
        const safeSetContent = (element, value) => {
            if (element) {
                element.textContent = value;
            }
        };

        // Fonction principale de mise à jour de l'aperçu
        function updatePreview() {
            const loyer = parseFloat(inputs.loyer.value) || 0;
            const charges = parseFloat(inputs.charges.value) || 0;
            const total = loyer + charges;
            
            const periodeValue = inputs.periode.value;
            const [year, month] = periodeValue.split('-');
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

            // Mise à jour de l'aperçu Quittance (utilise l'affectation sécurisée)
            safeSetContent(previews.propNom, inputs.propNom.value);
            safeSetContent(previews.propContact, inputs.propContact.value);
            safeSetContent(previews.propContactSmall, inputs.propContact.value);
            safeSetContent(previews.locNom, inputs.locNom.value);
            safeSetContent(previews.locAdresse, inputs.locAdresse.value);
            safeSetContent(previews.locEmail, inputs.locEmail.value); 
            safeSetContent(previews.locTel, inputs.locTel.value); 
            
            safeSetContent(previews.periode, `Mois de ${monthName}`);
            
            safeSetContent(previews.propNomText, inputs.propNom.value);
            safeSetContent(previews.locAdresseText, inputs.locAdresse.value);
            safeSetContent(previews.locNomText, inputs.locNom.value);
            
            const totalWords = numberToWordsFrench(total);

            // Formatage monétaire
            const loyerFormatted = `${loyer.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            const chargesFormatted = `${charges.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            const totalFormatted = `${total.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;

            safeSetContent(previews.loyer, loyerFormatted);
            safeSetContent(previews.charges, chargesFormatted);
            safeSetContent(previews.total, totalFormatted);
            safeSetContent(previews.totalText, `${totalWords} (${totalFormatted})`);

            const dateEmissionValue = inputs.dateEmission.value;
            if(dateEmissionValue) {
                const [y, m, d] = dateEmissionValue.split('-');
                const formattedDate = `${d} ${new Date(y, m - 1, d).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
                safeSetContent(previews.dateEmission, formattedDate);
            }

            safeSetContent(previews.signature, inputs.propNom.value);
            
            updateChart(loyer, charges);
        }
        
        // Initialisation du graphique Chart.js
        function initChart() {
            if (chartInitialized) return;

            const ctx = document.getElementById('repartitionChart').getContext('2d');
            repartitionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Loyer', 'Charges'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#3b82f6', '#f59e0b'], /* Couleurs coordonnées */
                        borderColor: '#ffffff',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (context.parsed !== null) {
                                        label += ': ' + context.parsed.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            chartInitialized = true;
        }

        // Mise à jour du graphique
        function updateChart(loyer, charges) {
            if (repartitionChart) {
                repartitionChart.data.datasets[0].data = [loyer, charges];
                repartitionChart.update();
            }
        }

        // 4. Initialisation et écouteurs
        document.addEventListener('DOMContentLoaded', () => {
            // Initialisation de la date d'émission à la date du jour
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            inputs.dateEmission.value = `${yyyy}-${mm}-${dd}`;

            // Initialisation de Firebase et de l'authentification
            initFirebaseAndAuth();

            // Crée une version debounced de updatePreview avec un délai de 250ms
            const debouncedUpdatePreview = debounce(updatePreview, 250); 

            // Écouteurs pour la mise à jour des champs (utilise la version debounced)
            const updatableInputs = [inputs.periode, inputs.dateEmission, inputs.loyer, inputs.charges, inputs.propNom, inputs.propContact, inputs.locNom, inputs.locAdresse, inputs.locEmail, inputs.locTel];
            updatableInputs.forEach(input => {
                input.addEventListener('keyup', debouncedUpdatePreview);
                input.addEventListener('change', debouncedUpdatePreview);
            });
            
            // Événements des boutons de gestion
            inputs.propertySelector.addEventListener('change', (e) => loadPropertyData(e.target.value));
            inputs.saveBtn.addEventListener('click', savePropertyData);
            inputs.addNewBtn.addEventListener('click', () => clearForm(false)); 
            inputs.deleteBtn.addEventListener('click', deleteSelectedProperty); 
            inputs.emailBtn.addEventListener('click', sendQuittanceEmail);

            // Bouton d'impression
            document.getElementById('print-btn').addEventListener('click', () => { window.print(); });

            initChart();
            updatePreview(); // Mise à jour initiale
        });
    </script>
</body>
</html>
