<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Quittance Multi-Propriété</title>
    <!-- Chargement de Tailwind CSS pour un design responsive et moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de Chart.js pour la visualisation des données -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Styles de base pour l'esthétique et la réactivité */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } 
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem;
            appearance: none; /* Cache la flèche par défaut pour select */
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: #4a90e2; /* Bleu d'origine */
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #4a5568; }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.08);
            padding: 1.5rem; 
        }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            text-align: center; 
            cursor: pointer; 
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        /* Style des boutons d'action */
        .btn-primary { 
            background-color: #4a90e2; /* Bleu d'origine */
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(74, 144, 226, 0.4); 
        }
        .btn-primary:hover { background-color: #3a7fd0; }

        .btn-green {
            background-color: #10b981;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
        }
        .btn-green:hover { background-color: #059669; }

        .btn-yellow {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.4);
        }
        .btn-yellow:hover { background-color: #d97706; }

        .btn-red {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4);
        }
        .btn-red:hover { background-color: #dc2626; }

        .btn-blue { /* Nouveau style pour l'e-mail */
            background-color: #3b82f6; 
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
        }
        .btn-blue:hover { background-color: #2563eb; }
        
        /* Conteneur pour le graphique */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
        }

        /* Styles d'impression : Masque les outils pour imprimer uniquement la quittance */
        @media print {
            body * { visibility: hidden; }
            #quittance-preview, #quittance-preview * { visibility: visible; }
            #quittance-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10 no-print">
            <h1 class="text-3xl font-bold text-gray-900">Générateur de Quittance Multi-Propriété</h1>
            <p class="text-gray-600 mt-1">Gérez vos biens et générez des quittances personnalisées.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- VOLET GAUCHE : FORMULAIRE D'ÉDITION -->
            <div class="space-y-8 no-print">
                
                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Sélection & Gestion de la Propriété</h2>
                    <label for="property-selector" class="form-label">Propriété :</label>
                    <select id="property-selector" class="form-select mb-4"></select>

                    <div class="grid grid-cols-3 gap-3">
                        <button id="add-new-btn" class="btn btn-green">Nouveau Bien</button>
                        <button id="save-btn" class="btn btn-yellow">Enregistrer les Modifs</button>
                        <button id="delete-btn" class="btn btn-red" disabled>Supprimer ce Bien</button>
                    </div>
                    <p id="action-message" class="text-sm mt-3 text-center font-medium text-gray-500"></p>
                </section>

                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Paramètres de la Quittance</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="periode" class="form-label">Période (Mois/Année)</label>
                            <input type="month" id="periode" class="form-input" value="2025-09">
                        </div>
                        <div>
                            <label for="date-emission" class="form-label">Date d'émission</label>
                            <input type="date" id="date-emission" class="form-input">
                        </div>
                        <div>
                            <label for="loyer" class="form-label">Loyer Hors Charges (€)</label>
                            <input type="number" id="loyer" class="form-input" value="448.85" step="0.01">
                        </div>
                        <div>
                            <label for="charges" class="form-label">Charges (€)</label>
                            <input type="number" id="charges" class="form-input" value="91.00" step="0.01">
                        </div>
                    </div>
                </section>

                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Informations des Parties</h2>
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700">Propriétaire</h3>
                        <input type="text" id="prop-nom" class="form-input" placeholder="Nom du Propriétaire" value="René Osias ASSENDAHI">
                        <input type="text" id="prop-contact" class="form-input" placeholder="Contact Propriétaire (Tél/Email)" value="0668336085 / essonne1992@gmail.com">
                    </div>
                    <div class="space-y-4 mt-6">
                        <h3 class="font-semibold text-gray-700">Locataire</h3>
                        <input type="text" id="loc-nom" class="form-input" placeholder="Nom du Locataire" value="SOLIHA SEINE ET MARNE">
                        <input type="text" id="loc-adresse" class="form-input" placeholder="Adresse du Logement" value="76 rue dian fossey 77000 melun">
                        <input type="email" id="loc-email" class="form-input" placeholder="Adresse E-mail du Locataire" value="">
                        <input type="tel" id="loc-tel" class="form-input" placeholder="Numéro de téléphone du Locataire" value="">
                    </div>
                </section>
                
                <!-- Section de visualisation (Graphique de Loyer/Charges) -->
                <section class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Composition du Loyer</h2>
                    <div class="chart-container">
                        <canvas id="repartitionChart"></canvas>
                    </div>
                </section>
            </div>

            <!-- VOLET DROIT : APERÇU DE LA QUITTANCE IMPRIMABLE -->
            <div>
                <section id="quittance-preview" class="card quittance-preview flex flex-col p-8 md:p-12">
                    <h2 class="text-3xl font-bold text-center mb-8 text-blue-700">QUITTANCE DE LOYER</h2>

                    <!-- Bloc infos (Propriétaire/Locataire) -->
                    <div class="grid grid-cols-2 gap-8 mb-8 text-sm">
                        <div>
                            <h3 class="font-semibold border-b border-blue-200 text-blue-800 pb-1 mb-2">PROPRIÉTAIRE</h3>
                            <p id="preview-prop-nom" class="font-medium"></p>
                            <p id="preview-prop-contact" class="text-gray-600"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold border-b border-blue-200 text-blue-800 pb-1 mb-2">LOCATAIRE</h3>
                            <p id="preview-loc-nom" class="font-medium"></p>
                            <p id="preview-loc-email" class="text-gray-600"></p>
                            <p id="preview-loc-tel" class="text-gray-600"></p>
                            <p class="text-gray-600 mt-2">Logement situé au :</p>
                            <p id="preview-loc-adresse" class="font-medium"></p>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <p class="text-lg"><strong>Période :</strong> <span id="preview-periode"></span></p>
                    </div>

                    <!-- Texte principal avec le total en toutes lettres -->
                    <p class="mb-6">Je soussigné, <strong id="preview-prop-nom-text"></strong>, propriétaire du logement situé au <strong id="preview-loc-adresse-text"></strong>, atteste avoir reçu, de la part de <strong id="preview-loc-nom-text"></strong>, la somme de <strong id="total-text"></strong>, se décomposant comme suit :</p>

                    <!-- Tableau des montants -->
                    <table class="w-full mb-8 border border-blue-300">
                        <thead class="bg-blue-100 text-blue-900">
                            <tr>
                                <th class="text-left p-3 font-semibold">Désignation</th>
                                <th class="text-right p-3 font-semibold">Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t">
                                <td class="p-3">Loyer</td>
                                <td id="preview-loyer" class="text-right p-3"></td>
                            </tr>
                            <tr class="border-t">
                                <td class="p-3">Charges</td>
                                <td id="preview-charges" class="text-right p-3"></td>
                            </tr>
                            <tr class="border-t bg-blue-50 text-blue-900 font-bold">
                                <td class="p-3">TOTAL</td>
                                <td id="preview-total" class="text-right p-3"></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Signature et date -->
                    <div class="text-center mt-auto">
                        <p class="mb-8">Fait le <span id="preview-date-emission"></span></p>
                        <p class="font-semibold" id="preview-signature"></p>
                    </div>
                    <!-- Mentions légales (du modèle PDF) -->
                    <div class="text-xs text-gray-500 mt-12 pt-4 border-t">
                        <p>Le paiement de la présente n'emporte pas présomption de paiement des termes antérieurs. Cette quittance ou ce reçu annule tous les reçus qui auraient pu être donnés pour acompte versé sur le présent terme. En cas de congé précédemment donné, cette quittance ou ce reçu représenterait l'indemnité d'occupation et ne saurait être considéré comme un titre d'occupation. Sous réserve d'encaissement.</p>
                    </div>
                </section>
                
                <div class="card text-center mt-4 no-print grid grid-cols-2 gap-4">
                    <button id="email-btn" class="btn btn-blue w-full">Envoyer par E-mail</button>
                    <button id="print-btn" class="btn btn-primary w-full">Imprimer la Quittance</button>
                </div>
                <div id="email-instruction" class="card text-sm p-3 mt-4 text-center text-gray-600 hidden no-print">
                    ⚠️ **Étape manuelle requise :** Le PDF ne peut pas être joint automatiquement. N'oubliez pas d'utiliser le bouton **"Imprimer la Quittance"** (choisir 'Enregistrer en PDF') puis de glisser-déposer le fichier PDF dans l'e-mail pré-rempli.
                </div>
            </div>
        </main>
    </div>

    <script>
        // DONNÉES DE DÉPART POUR LES PROPRIÉTÉS
        // Le stockage se fait dans le navigateur (localStorage) car c'est une version simple sans Cloud.
        const LOCAL_STORAGE_KEY = 'multiPropertyData';

        let propertiesData = loadInitialData();

        function loadInitialData() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    return JSON.parse(savedData);
                } catch (e) {
                    console.error("Erreur de chargement des données locales.", e);
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                }
            }
            // Données par défaut si rien n'est trouvé
            return [
                { id: Date.now(), locataire: "SOLIHA SEINE ET MARNE", email: "soliha@example.com", telephone: "06 12 34 56 78", adresse: "76 rue dian fossey 77000 melun", loyer_hc: 448.85, charges: 91.00 },
                { id: Date.now() + 1, locataire: "Jean Dupont", email: "jean.dupont@locataire.com", telephone: "07 98 76 54 32", adresse: "12 rue de Rivoli 75004 Paris", loyer_hc: 850.00, charges: 75.00 },
                { id: Date.now() + 2, locataire: "Marie Martin", email: "marie.martin@locataire.com", telephone: "06 55 44 33 22", adresse: "25 quai Saint-Vincent 69001 Lyon", loyer_hc: 620.00, charges: 55.00 }
            ];
        }

        function saveLocalData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(propertiesData));
        }

        // Récupération des éléments HTML (Inputs et Zones d'affichage)
        const inputs = {
            propertySelector: document.getElementById('property-selector'),
            periode: document.getElementById('periode'),
            dateEmission: document.getElementById('date-emission'),
            loyer: document.getElementById('loyer'),
            charges: document.getElementById('charges'),
            propNom: document.getElementById('prop-nom'),
            propContact: document.getElementById('prop-contact'),
            locNom: document.getElementById('loc-nom'),
            locAdresse: document.getElementById('loc-adresse'),
            locEmail: document.getElementById('loc-email'), 
            locTel: document.getElementById('loc-tel'),     
            saveBtn: document.getElementById('save-btn'),
            addNewBtn: document.getElementById('add-new-btn'),
            deleteBtn: document.getElementById('delete-btn'), 
            actionMessage: document.getElementById('action-message'),
            emailBtn: document.getElementById('email-btn'), // NOUVEAU
            emailInstruction: document.getElementById('email-instruction'), // NOUVEAU
        };

        const previews = {
            propNom: document.getElementById('preview-prop-nom'),
            propContact: document.getElementById('preview-prop-contact'),
            locNom: document.getElementById('preview-loc-nom'),
            locAdresse: document.getElementById('preview-loc-adresse'),
            locEmail: document.getElementById('preview-loc-email'), 
            locTel: document.getElementById('preview-loc-tel'),     
            periode: document.getElementById('preview-periode'),
            propNomText: document.getElementById('preview-prop-nom-text'),
            locAdresseText: document.getElementById('preview-loc-adresse-text'),
            locNomText: document.getElementById('preview-loc-nom-text'),
            totalText: document.getElementById('total-text'),
            loyer: document.getElementById('preview-loyer'),
            charges: document.getElementById('preview-charges'),
            total: document.getElementById('preview-total'),
            dateEmission: document.getElementById('preview-date-emission'),
            signature: document.getElementById('preview-signature'),
        };

        let repartitionChart;

        // Fonction pour remplir le menu déroulant
        function populatePropertySelector(selectedIndex = 0) {
            inputs.propertySelector.innerHTML = '';
            
            if (propertiesData.length === 0) {
                 const option = document.createElement('option');
                 option.value = -1;
                 option.textContent = "--- Ajouter une propriété ---";
                 inputs.propertySelector.appendChild(option);
                 clearForm();
                 inputs.deleteBtn.disabled = true; // Désactive la suppression si la liste est vide
                 return;
            }

            propertiesData.forEach((prop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${prop.locataire} - ${prop.adresse}`; // Affichage Locataire + Adresse
                inputs.propertySelector.appendChild(option);
            });
            
            // Sélectionne le dernier élément enregistré ou le premier
            inputs.propertySelector.value = Math.min(selectedIndex, propertiesData.length - 1); 
            loadPropertyData(inputs.propertySelector.value);
            inputs.deleteBtn.disabled = false; // Active la suppression si des éléments existent
        }

        // Fonction pour charger les données d'un bien sélectionné
        function loadPropertyData(index) {
            const prop = propertiesData[index];

            if (prop) {
                // Mise à jour des champs avec les données du bien
                inputs.locNom.value = prop.locataire || '';
                inputs.locAdresse.value = prop.adresse || '';
                inputs.locEmail.value = prop.email || '';
                inputs.locTel.value = prop.telephone || '';
                inputs.loyer.value = prop.loyer_hc ? prop.loyer_hc.toFixed(2) : '0.00';
                inputs.charges.value = prop.charges ? prop.charges.toFixed(2) : '0.00';
            }
            updatePreview();
        }
        
        // Vider les champs pour l'ajout d'un nouveau bien
        function clearForm() {
            inputs.locNom.value = "";
            inputs.locAdresse.value = "";
            inputs.locEmail.value = "";
            inputs.locTel.value = "";
            inputs.loyer.value = "0.00";
            inputs.charges.value = "0.00";
            inputs.propertySelector.value = -1; 
            inputs.actionMessage.textContent = "Saisissez les données du nouveau bien et cliquez sur 'Enregistrer les Modifs'.";
            inputs.deleteBtn.disabled = true; // Désactive la suppression lors de la création
            updatePreview();
        }

        // Sauvegarder ou mettre à jour un bien
        function savePropertyData() {
            const selectedIndex = inputs.propertySelector.value;
            
            // Validation simple pour ne pas enregistrer un bien vide
            if (inputs.locNom.value === "" || inputs.locAdresse.value === "") {
                inputs.actionMessage.textContent = "Veuillez remplir au moins le Nom du Locataire et l'Adresse.";
                return;
            }

            const propertyData = {
                locataire: inputs.locNom.value,
                email: inputs.locEmail.value,
                telephone: inputs.locTel.value,
                adresse: inputs.locAdresse.value,
                loyer_hc: parseFloat(inputs.loyer.value) || 0,
                charges: parseFloat(inputs.charges.value) || 0
            };
            
            if (selectedIndex !== null && selectedIndex !== "" && selectedIndex !== '-1' && selectedIndex < propertiesData.length) {
                // MISE À JOUR d'un bien existant
                propertyData.id = propertiesData[selectedIndex].id;
                propertiesData[selectedIndex] = propertyData;
                inputs.actionMessage.textContent = "Bien mis à jour avec succès (enregistré localement).";
                populatePropertySelector(selectedIndex);
            } else {
                // AJOUT d'un nouveau bien
                propertyData.id = Date.now();
                propertiesData.push(propertyData);
                inputs.actionMessage.textContent = "Nouveau bien ajouté avec succès (enregistré localement).";
                populatePropertySelector(propertiesData.length - 1);
            }
            saveLocalData();
        }

        // NOUVEAU: Fonction pour supprimer le bien sélectionné
        function deleteSelectedProperty() {
            const selectedIndex = inputs.propertySelector.value;
            
            if (selectedIndex === null || selectedIndex === "" || selectedIndex === '-1' || selectedIndex >= propertiesData.length) {
                inputs.actionMessage.textContent = "Aucun bien sélectionné à supprimer.";
                return;
            }

            // Simuler une confirmation (dans un environnement réel, on utiliserait une modale)
            const confirmDelete = true; 
            if (confirmDelete) {
                propertiesData.splice(selectedIndex, 1); // Supprime l'élément du tableau
                saveLocalData(); // Sauvegarde le tableau mis à jour
                inputs.actionMessage.textContent = "Bien supprimé avec succès.";
                populatePropertySelector(0); // Recharge la liste et sélectionne le premier élément
            }
        }
        
        // NOUVEAU: Fonction pour générer l'e-mail
        function sendQuittanceEmail() {
            const locataireEmail = inputs.locEmail.value;
            const locataireName = inputs.locNom.value;
            const periode = previews.periode.textContent; 
            const total = previews.total.textContent;
            
            if (!locataireEmail || !locataireEmail.includes('@')) {
                inputs.actionMessage.textContent = "L'adresse e-mail du locataire est manquante ou invalide. Veuillez la renseigner.";
                return;
            }

            const subject = `Votre Quittance de Loyer pour la période ${periode}`;
            const body = `Bonjour ${locataireName},\n\nVeuillez trouver ci-joint votre quittance de loyer d'un montant total de ${total} pour la période ${periode}.\n\nCordialement,\n${inputs.propNom.value}`;

            // Utilisation du protocole mailto: pour ouvrir le client mail
            const mailtoLink = `mailto:${locataireEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Afficher l'instruction de sauvegarde PDF
            inputs.emailInstruction.classList.remove('hidden');
            
            window.location.href = mailtoLink;
        }


        // Fonction de conversion de nombre à toutes lettres (Français)
        function numberToWordsFrench(n) {
            if (n === 0) return 'Zéro Euro';
            const s = n.toString();
            let part = s.split('.');
            let euros = parseInt(part[0]);
            let centimes = part.length > 1 ? parseInt(part[1].padEnd(2, '0')) : 0;

            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];

            function convert(num) {
                if (num < 10) return units[num];
                if (num < 20) return teens[num - 10];
                if (num < 70) {
                    let ten = Math.floor(num / 10);
                    let unit = num % 10;
                    if (ten === 6 && unit <= 9) { return 'soixante-' + convert(num - 60); }
                    return tens[ten] + (unit > 0 ? (unit === 1 && ten === 7 || ten === 9 ? '-et-' : '-') + units[unit] : '');
                }
                if (num < 80) { return 'soixante-' + convert(num - 60); }
                if (num < 90) { return 'quatre-vingt' + (num > 80 ? ('-' + convert(num - 80)) : ''); }
                if (num < 100) { return 'quatre-vingt-dix-' + convert(num - 90); }
                if (num < 200) { return 'cent' + (num > 100 ? ' ' + convert(num - 100) : ''); }
                if (num < 1000) {
                   let cent = Math.floor(num / 100);
                   let reste = num % 100;
                   let res = units[cent] + (cent > 1 && reste === 0 ? ' cents' : ' cent');
                   return res + (reste > 0 ? ' ' + convert(reste) : '');
                }
                if (num < 1000000) {
                    let mille = Math.floor(num / 1000);
                    let reste = num % 1000;
                    let res = (mille > 1 ? convert(mille) + ' mille' : 'mille');
                    return res + (reste > 0 ? ' ' + convert(reste) : '');
                }
                return '';
            }
            
            let euroText = convert(euros).trim() + (euros > 1 ? ' Euros' : ' Euro');
            let centimeText = centimes > 0 ? (centimes > 1 ? ' et ' + convert(centimes) + ' centimes' : ' et un centime') : '';
            let result = euroText + centimeText;
            return result.charAt(0).toUpperCase() + result.slice(1);
        }

        // Fonction principale de mise à jour de l'aperçu
        function updatePreview() {
            const loyer = parseFloat(inputs.loyer.value) || 0;
            const charges = parseFloat(inputs.charges.value) || 0;
            const total = loyer + charges;
            
            const periodeValue = inputs.periode.value;
            const [year, month] = periodeValue.split('-');
            const startDate = `01-${month}-${year}`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${lastDay}-${month}-${year}`;

            // Mise à jour de l'aperçu Quittance
            previews.propNom.textContent = inputs.propNom.value;
            previews.propContact.textContent = inputs.propContact.value;
            previews.locNom.textContent = inputs.locNom.value;
            previews.locAdresse.textContent = inputs.locAdresse.value;
            previews.locEmail.textContent = inputs.locEmail.value; 
            previews.locTel.textContent = inputs.locTel.value;     
            previews.periode.textContent = `du ${startDate} au ${endDate}`;
            
            previews.propNomText.textContent = inputs.propNom.value;
            previews.locAdresseText.textContent = inputs.locAdresse.value;
            previews.locNomText.textContent = inputs.locNom.value;
            
            previews.loyer.textContent = `${loyer.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            previews.charges.textContent = `${charges.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            previews.total.textContent = `${total.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            previews.totalText.textContent = numberToWordsFrench(total);

            const dateEmissionValue = inputs.dateEmission.value;
            if(dateEmissionValue) {
                const [y, m, d] = dateEmissionValue.split('-');
                previews.dateEmission.textContent = `${d}-${m}-${y}`;
            }

            previews.signature.textContent = inputs.propNom.value;
            
            updateChart(loyer, charges);
        }
        
        // Initialisation du graphique Chart.js
        function initChart() {
            const ctx = document.getElementById('repartitionChart').getContext('2d');
            repartitionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Loyer', 'Charges'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#4a90e2', '#f5a623'], 
                        borderColor: '#ffffff',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (context.parsed !== null) {
                                        label += ': ' + context.parsed.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Mise à jour du graphique
        function updateChart(loyer, charges) {
            if (repartitionChart) {
                repartitionChart.data.datasets[0].data = [loyer, charges];
                repartitionChart.update();
            }
        }

        // 4. Initialisation et écouteurs
        document.addEventListener('DOMContentLoaded', () => {
            // Initialisation de la date d'émission à la date du jour
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            inputs.dateEmission.value = `${yyyy}-${mm}-${dd}`;

            // Écouteurs pour la mise à jour des champs
            const updatableInputs = [inputs.periode, inputs.dateEmission, inputs.loyer, inputs.charges, inputs.propNom, inputs.propContact, inputs.locNom, inputs.locAdresse, inputs.locEmail, inputs.locTel];
            updatableInputs.forEach(input => {
                input.addEventListener('keyup', updatePreview);
                input.addEventListener('change', updatePreview);
            });
            
            // Événements du sélecteur et des boutons de gestion
            inputs.propertySelector.addEventListener('change', (e) => loadPropertyData(e.target.value));
            inputs.saveBtn.addEventListener('click', savePropertyData);
            inputs.addNewBtn.addEventListener('click', clearForm);
            inputs.deleteBtn.addEventListener('click', deleteSelectedProperty); 
            inputs.emailBtn.addEventListener('click', sendQuittanceEmail); // NOUVEAU

            // Bouton d'impression
            document.getElementById('print-btn').addEventListener('click', () => { window.print(); });

            initChart();
            populatePropertySelector(); // Charge les données locales ou initiales
            updatePreview(); 
        });
    </script>
</body>
</html>
