<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Quittance & Gestion Locative</title>
    <!-- Chargement de Tailwind CSS pour un design responsive et moderne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de Chart.js pour la visualisation des données -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Importations Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Définition des variables globales (disponibles après l'initialisation)
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.setLogLevel = setLogLevel;
    </script>
    
    <style>
        /* Styles de base pour l'esthétique et la réactivité */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } /* Gris légèrement plus chaud */
        .form-input, .form-select { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem;
            appearance: none; /* Cache la flèche par défaut pour select */
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: #10b981; /* Vert forêt */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); /* Ombre verte */
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #4a5568; }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.08); /* Ombre plus douce */
            padding: 1.5rem; 
        }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            text-align: center; 
            cursor: pointer; 
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-primary { 
            background-color: #10b981; /* Vert forêt */
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4); 
        }
        .btn-primary:hover { background-color: #059669; } /* Vert plus foncé au survol */
        .btn-secondary {
            background-color: #ef4444; /* Rouge pour Supprimer/Danger */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); 
        }
        .btn-secondary:hover { background-color: #dc2626; } /* Rouge plus foncé */
        .btn-blue {
            background-color: #3b82f6; /* Bleu pour Email */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); 
        }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-tab.active {
            background-color: #10b981;
            color: white;
        }
        .btn-tab:not(.active):hover {
            background-color: #e5e7eb;
        }
        
        /* Conteneur pour le graphique (essentiel pour la réactivité de Chart.js) */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Styles d'impression : Masque les outils (formulaires/boutons) pour imprimer uniquement la quittance */
        @media print {
            body * { visibility: hidden; }
            #quittance-preview, #quittance-preview * { visibility: visible; }
            #quittance-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10 no-print">
            <h1 class="text-4xl font-bold text-gray-900">Générateur de Quittance & Gestion Locative</h1>
            <p class="text-lg text-gray-600 mt-2">Gérez, éditez et sauvegardez vos propriétés en temps réel (Sauvegarde Cloud).</p>
            <div id="auth-status" class="mt-2 text-sm text-gray-500">Connexion en cours...</div>
            <div id="user-info" class="mt-1 text-xs text-gray-400">ID Utilisateur: <span id="user-id">N/A</span></div>
        </header>

        <!-- NOUVEAU: Onglets de navigation -->
        <nav class="flex justify-center space-x-2 mb-8 no-print p-2 rounded-lg bg-white shadow">
            <button id="tab-quittance-btn" data-tab="quittance" class="btn-tab active">1. Quittance & Saisie</button>
            <button id="tab-suivi-btn" data-tab="suivi" class="btn-tab">2. Suivi Financier</button>
        </nav>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- VOLET GAUCHE : FORMULAIRE D'ÉDITION (Partie commune pour le Cloud) -->
            <div class="space-y-8 no-print">
                <section class="card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Sélection et Gestion des Biens</h2>
                    <label for="property-selector" class="form-label text-xl font-bold">Choisir la Propriété :</label>
                    <select id="property-selector" class="form-select mb-4"></select>

                    <button id="add-new-btn" class="btn btn-blue w-full">Ajouter une Nouvelle Propriété</button>
                    
                    <div id="action-message" class="text-sm mt-3 text-center font-medium"></div>

                </section>

                <!-- CONTENU DE L'ONGLET 1 : QUITTANCE & SAISIE -->
                <div id="tab-content-quittance">
                    <section class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Paramètres de la Quittance</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="periode" class="form-label">Période (Mois)</label>
                                <input type="month" id="periode" class="form-input" value="2025-09">
                            </div>
                            <div>
                                <label for="date-emission" class="form-label">Date d'émission</label>
                                <input type="date" id="date-emission" class="form-input">
                            </div>
                            <div>
                                <label for="loyer" class="form-label">Loyer Hors Charges (€)</label>
                                <input type="number" id="loyer" class="form-input" value="0.00" step="0.01">
                            </div>
                            <div>
                                <label for="charges" class="form-label">Charges (€)</label>
                                <input type="number" id="charges" class="form-input" value="0.00" step="0.01">
                            </div>
                        </div>
                    </section>

                    <section class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Parties (Sauvegardées)</h2>
                        <div class="space-y-6">
                            <!-- Infos Propriétaire (MODIFIABLE et SAUVEGARDABLE) -->
                            <div>
                                <h3 class="text-lg font-semibold mb-2 text-gray-700">Propriétaire</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="prop-nom" class="form-label">Nom</label><input type="text" id="prop-nom" class="form-input"></div>
                                    <div><label for="prop-contact" class="form-label">Contact</label><input type="text" id="prop-contact" class="form-input"></div>
                                </div>
                            </div>
                            <!-- Infos Locataire (MODIFIABLE et SAUVEGARDABLE) -->
                            <div>
                                <h3 class="text-lg font-semibold mb-2 text-gray-700">Locataire</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="col-span-3 md:col-span-1"><label for="loc-nom" class="form-label">Nom Locataire</label><input type="text" id="loc-nom" class="form-input" value=""></div>
                                    <div class="col-span-3 md:col-span-1"><label for="loc-email" class="form-label">E-mail Locataire</label><input type="email" id="loc-email" class="form-input" placeholder="exemple@locataire.com" value=""></div>
                                    <div class="col-span-3 md:col-span-1"><label for="loc-adresse" class="form-label">Adresse du logement</label><input type="text" id="loc-adresse" class="form-input" value=""></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Boutons de Sauvegarde et Suppression -->
                        <div class="mt-6 grid grid-cols-2 gap-4">
                            <button id="save-btn" class="btn btn-primary">Sauvegarder ce Bien</button>
                            <button id="delete-btn" class="btn btn-secondary" disabled>Supprimer ce Bien</button>
                        </div>

                    </section>
                    
                    <!-- Section de visualisation (Graphique de Loyer/Charges) -->
                    <section class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Composition du Loyer</h2>
                        <p class="text-gray-600 mb-4">Aperçu visuel de la répartition Loyer / Charges.</p>
                        <div class="chart-container">
                            <canvas id="repartitionChart"></canvas>
                        </div>
                    </section>
                </div>

                <!-- CONTENU DE L'ONGLET 2 : SUIVI FINANCIER -->
                <div id="tab-content-suivi" class="hidden">
                    <section class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Bénéfice Net Mensuel</h2>
                        <p class="text-gray-600 mb-4">Évolution du Bénéfice Net (Loyer - Dépenses) sur l'année.</p>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="netBenefitChart"></canvas>
                        </div>
                    </section>

                    <section class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Synthèse Annuelle (Est.)</h2>
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 font-semibold">DESCRIPTION</th>
                                    <th class="p-3 font-semibold text-right">MONTANT</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="p-3">Total des loyers perçus (Annuel)</td>
                                    <td id="annual-rent" class="p-3 text-right font-medium text-green-700"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3">Total des dépenses (Annuel)</td>
                                    <td id="annual-expenses" class="p-3 text-right font-medium text-red-600"></td>
                                </tr>
                                <tr class="bg-green-50">
                                    <td class="p-3 font-bold">Bénéfice net annuel</td>
                                    <td id="annual-net" class="p-3 text-right font-bold text-green-900"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="p-3">Rentabilité brute (Est.)</td>
                                    <td id="annual-profitability" class="p-3 text-right font-bold text-blue-600"></td>
                                </tr>
                            </tbody>
                        </table>
                    </section>
                    
                    <section class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Détail des flux mensuels (Exemple)</h2>
                        <table class="w-full text-left border-collapse text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-2 font-semibold">MOIS</th>
                                    <th class="p-2 font-semibold text-right">LOYER</th>
                                    <th class="p-2 font-semibold text-right">DÉPENSES</th>
                                    <th class="p-2 font-semibold text-right">BÉNÉFICE NET</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-detail">
                                <!-- Données insérées par JS -->
                            </tbody>
                        </table>
                        <p class="text-xs text-gray-500 mt-4">*Ces données sont un exemple tiré de votre feuille de calcul et ne sont pas liées aux champs de quittance.</p>
                    </section>
                </div>
            </div>

            <!-- VOLET DROIT : APERÇU DE LA QUITTANCE IMPRIMABLE (Reste affiché pour la quittance) -->
            <div id="right-panel">
                 <section id="quittance-preview" class="card quittance-preview flex flex-col p-8 md:p-12">
                    <h2 class="text-3xl font-bold text-center mb-8 text-green-700">QUITTANCE DE LOYER</h2>

                    <!-- Bloc infos (Propriétaire/Locataire) -->
                    <div class="grid grid-cols-2 gap-8 mb-8 text-sm">
                        <div>
                            <h3 class="font-semibold border-b border-green-200 text-green-800 pb-1 mb-2">PROPRIÉTAIRE</h3>
                            <p id="preview-prop-nom" class="font-medium"></p>
                            <p id="preview-prop-contact" class="text-gray-600"></p>
                        </div>
                        <div>
                            <h3 class="font-semibold border-b border-green-200 text-green-800 pb-1 mb-2">LOCATAIRE</h3>
                            <p id="preview-loc-nom" class="font-medium"></p>
                            <p id="preview-loc-email" class="text-gray-600"></p>
                            <p class="text-gray-600">Logement situé au :</p>
                            <p id="preview-loc-adresse" class="font-medium"></p>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <p class="text-lg"><strong>Période :</strong> <span id="preview-periode"></span></p>
                    </div>

                    <!-- Texte principal avec le total en toutes lettres -->
                    <p class="mb-6">Je soussigné, <strong id="preview-prop-nom-text"></strong>, propriétaire du logement situé au <strong id="preview-loc-adresse-text"></strong>, atteste avoir reçu, de la part de <strong id="preview-loc-nom-text"></strong>, la somme de <strong id="total-text"></strong>, se décomposant comme suit :</p>

                    <!-- Tableau des montants -->
                    <table class="w-full mb-8 border border-green-300">
                        <thead class="bg-green-100 text-green-900">
                            <tr>
                                <th class="text-left p-3 font-semibold">Désignation</th>
                                <th class="text-right p-3 font-semibold">Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t">
                                <td class="p-3">Loyer</td>
                                <td id="preview-loyer" class="text-right p-3"></td>
                            </tr>
                            <tr class="border-t">
                                <td class="p-3">Charges</td>
                                <td id="preview-charges" class="text-right p-3"></td>
                            </tr>
                            <tr class="border-t bg-green-50 text-green-900 font-bold">
                                <td class="p-3">TOTAL</td>
                                <td id="preview-total" class="text-right p-3"></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Signature et date -->
                    <div class="text-center mt-auto">
                        <p class="mb-8">Fait le <span id="preview-date-emission"></span></p>
                        <p class="font-semibold" id="preview-signature"></p>
                    </div>
                     <!-- Mentions légales (du modèle PDF) -->
                     <div class="text-xs text-gray-500 mt-12 pt-4 border-t">
                        <p>Le paiement de la présente n'emporte pas présomption de paiement des termes antérieurs. Cette quittance ou ce reçu annule tous les reçus qui auraient pu être donnés pour acompte versé sur le présent terme. En cas de congé précédemment donné, cette quittance ou ce reçu représenterait l'indemnité d'occupation et ne saurait être considéré comme un titre d'occupation. Sous réserve d'encaissement.</p>
                    </div>
                </section>
                
                <div class="card text-center no-print grid grid-cols-1 md:grid-cols-2 gap-4">
                     <button id="email-btn" class="btn btn-blue">Envoyer par E-mail</button>
                     <button id="print-btn" class="btn btn-primary">Imprimer la Quittance</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Variables globales pour Firebase
        let db, auth, currentUserId, currentProperties = [];
        let repartitionChart, netBenefitChart; // Ajout du graphique de bénéfice net
        let isAuthReady = false;

        // Données INITIALES POUR LA QUITTANCE (Uniquement utilisées si la base est vide)
        const initialOwnerData = {
            nom: "René Osias ASSENDAHI",
            contact: "0668336085 / essonne1992@gmail.com"
        };
        const initialPropertiesData = [
            { id: 'prop1', locataire: "SOLIHA SEINE ET MARNE", email: "soliha.melun@example.com", adresse: "76 rue dian fossey 77000 melun", loyer_hc: 448.85, charges: 91.00 },
            { id: 'prop2', locataire: "Jean Dupont", email: "jean.dupont@locataire.com", adresse: "12 rue de Rivoli 75004 Paris", loyer_hc: 850.00, charges: 75.00 },
            { id: 'prop3', locataire: "Marie Martin", email: "marie.martin@locataire.com", adresse: "25 quai Saint-Vincent 69001 Lyon", loyer_hc: 620.00, charges: 55.00 }
        ];

        // NOUVEAU: Données du SUIVI FINANCIER (Extraites de votre Google Sheet - L'ID "prop1" est utilisé par défaut pour cette analyse)
        const monthlyData = [
            { mois: "JANVIER", loyer: 539.85, charges_copro: 233.90, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 700.83, benefice_net: -160.98 },
            { mois: "FÉVRIER", loyer: 539.85, charges_copro: 0, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 466.93, benefice_net: 72.92 },
            { mois: "MARS", loyer: 539.85, charges_copro: 0, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 466.93, benefice_net: 72.92 },
            { mois: "AVRIL", loyer: 539.85, charges_copro: 449.43, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 916.36, benefice_net: -376.51 },
            { mois: "MAI", loyer: 539.85, charges_copro: 0, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 466.93, benefice_net: 72.92 },
            { mois: "JUIN", loyer: 539.85, charges_copro: 91.00, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 557.93, benefice_net: -18.08 },
            { mois: "JUILLET", loyer: 539.85, charges_copro: 0, taxe_fonciere: 64, impot: 39, credit: 363.93, total_depenses: 466.93, benefice_net: 72.92 },
            { mois: "AOÛT", loyer: 539.85, charges_copro: 91.00, taxe_fonciere: 64, impot: 0, credit: 363.93, total_depenses: 518.93, benefice_net: 20.92 }, // Note: Impôt 0 dans la source pour Août-Oct
            { mois: "SEPTEMBRE", loyer: 539.85, charges_copro: 91.00, taxe_fonciere: 64, impot: 0, credit: 363.93, total_depenses: 518.93, benefice_net: 20.92 },
            { mois: "OCTOBRE", loyer: 539.85, charges_copro: 91.00, taxe_fonciere: 64, impot: 0, credit: 363.93, total_depenses: 518.93, benefice_net: 20.92 },
            { mois: "NOVEMBRE", loyer: 0, charges_copro: 0, taxe_fonciere: 0, impot: 0, credit: 0, total_depenses: 0, benefice_net: 0 },
            { mois: "DÉCEMBRE", loyer: 0, charges_copro: 0, taxe_fonciere: 0, impot: 0, credit: 0, total_depenses: 0, benefice_net: 0 }
        ];

        // 1. Récupération des éléments HTML (Inputs et Zones d'affichage)
        const inputs = {
            propertySelector: document.getElementById('property-selector'),
            periode: document.getElementById('periode'),
            dateEmission: document.getElementById('date-emission'),
            loyer: document.getElementById('loyer'),
            charges: document.getElementById('charges'),
            propNom: document.getElementById('prop-nom'),
            propContact: document.getElementById('prop-contact'),
            locNom: document.getElementById('loc-nom'),
            locEmail: document.getElementById('loc-email'), 
            locAdresse: document.getElementById('loc-adresse'),
            saveBtn: document.getElementById('save-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            addNewBtn: document.getElementById('add-new-btn'),
            actionMessage: document.getElementById('action-message'),
            // NOUVEAU: Onglets
            tabQuittance: document.getElementById('tab-content-quittance'),
            tabSuivi: document.getElementById('tab-content-suivi'),
            tabQuittanceBtn: document.getElementById('tab-quittance-btn'),
            tabSuiviBtn: document.getElementById('tab-suivi-btn'),
        };

        const previews = {
            propNom: document.getElementById('preview-prop-nom'),
            propContact: document.getElementById('preview-prop-contact'),
            locNom: document.getElementById('preview-loc-nom'),
            locEmail: document.getElementById('preview-loc-email'),
            locAdresse: document.getElementById('preview-loc-adresse'),
            periode: document.getElementById('preview-periode'),
            propNomText: document.getElementById('preview-prop-nom-text'),
            locAdresseText: document.getElementById('preview-loc-adresse-text'),
            locNomText: document.getElementById('preview-loc-nom-text'),
            totalText: document.getElementById('total-text'),
            loyer: document.getElementById('preview-loyer'),
            charges: document.getElementById('preview-charges'),
            total: document.getElementById('preview-total'),
            dateEmission: document.getElementById('preview-date-emission'),
            signature: document.getElementById('preview-signature'),
            // NOUVEAU: Suivi
            annualRent: document.getElementById('annual-rent'),
            annualExpenses: document.getElementById('annual-expenses'),
            annualNet: document.getElementById('annual-net'),
            annualProfitability: document.getElementById('annual-profitability'),
            monthlyDetail: document.getElementById('monthly-detail'),
        };

        // **********************************************************
        // ** 2. LOGIQUE FIREBASE & GESTION LOCATIVE               **
        // **********************************************************

        // Fonction pour obtenir le chemin de la collection des biens de l'utilisateur
        function getUserPropertiesCollectionRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return collection(db, `artifacts/${appId}/users/${currentUserId}/properties`);
        }
        
        // Fonction pour obtenir la référence au document du propriétaire
        function getOwnerDocRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return doc(db, `artifacts/${appId}/users/${currentUserId}/config/owner`);
        }

        // 2.1 Authentification et Initialisation
        async function initializeFirebase() {
            if (typeof window.initializeApp === 'undefined') {
                setTimeout(initializeFirebase, 100);
                return;
            }

            try {
                // setLogLevel('debug'); // Décommenter pour déboguer Firebase
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                
                // --- CORRECTION RENFORCÉE DE L'ERREUR D'INITIALISATION ---
                const isConfigValid = (config) => Object.keys(config).length > 0 && config.apiKey;

                if (!isConfigValid(firebaseConfig)) {
                    document.getElementById('auth-status').textContent = 'Erreur: Configuration Firebase manquante. La sauvegarde Cloud est désactivée.';
                    console.error("Firebase config is missing or empty.");
                    // Retourne tôt pour empêcher l'appel à initializeApp sans arguments
                    return; 
                }
                // --------------------------------------------------------
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                window.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('auth-status').textContent = 'Connecté (Gestion Cloud)';
                        document.getElementById('user-id').textContent = currentUserId;
                        isAuthReady = true;

                        // 3. Lancer les écouteurs de données
                        initializeDataListeners();
                    } else {
                        document.getElementById('auth-status').textContent = 'Déconnecté (Erreur)';
                    }
                });

            } catch (error) {
                console.error("Erreur d'initialisation Firebase:", error);
                document.getElementById('auth-status').textContent = 'Échec de la connexion.';
            }
        }

        // 2.2 Écouteurs en temps réel (Owner et Properties)
        function initializeDataListeners() {
            // Écouteur pour les informations du propriétaire
            const ownerRef = getOwnerDocRef();
            onSnapshot(ownerRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    inputs.propNom.value = data.nom || '';
                    inputs.propContact.value = data.contact || '';
                    updatePreview(); // Mise à jour de l'aperçu avec les infos du propriétaire
                } else {
                    saveOwnerData(initialOwnerData);
                }
            }, (error) => console.error("Erreur lecture propriétaire:", error));


            // Écouteur pour les propriétés
            const propertiesRef = getUserPropertiesCollectionRef();
            onSnapshot(propertiesRef, async (snapshot) => {
                if (snapshot.empty && isAuthReady) {
                    await initializePropertiesData();
                    return;
                }
                
                currentProperties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populatePropertySelector();

                const selectedIndex = inputs.propertySelector.value || '0';
                if (currentProperties.length > 0 && selectedIndex) {
                    loadPropertyData(selectedIndex);
                } else {
                    clearForm();
                }

                inputs.deleteBtn.disabled = currentProperties.length === 0;

            }, (error) => console.error("Erreur lecture propriétés:", error));
        }

        // 2.3 Initialisation et Sauvegarde
        async function initializePropertiesData() {
            if (!isAuthReady) return;
            inputs.actionMessage.textContent = "Initialisation des données de base...";

            const batch = [];
            initialPropertiesData.forEach((prop, index) => {
                const docRef = doc(getUserPropertiesCollectionRef(), `prop${index + 1}`);
                batch.push(setDoc(docRef, prop));
            });

            try {
                await Promise.all(batch);
                inputs.actionMessage.textContent = "Données de base chargées !";
            } catch (error) {
                console.error("Erreur d'initialisation des biens:", error);
                inputs.actionMessage.textContent = "Erreur lors du chargement initial.";
            }
        }

        async function saveOwnerData(data) {
            if (!isAuthReady) return;
            try {
                await setDoc(getOwnerDocRef(), data);
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du propriétaire:", error);
            }
        }
        
        async function savePropertyData(isNew = false) {
            if (!isAuthReady) {
                inputs.actionMessage.textContent = "Erreur: Connexion Cloud non établie. Impossible de sauvegarder.";
                return;
            }
            inputs.actionMessage.textContent = "Sauvegarde en cours...";
            
            await saveOwnerData({
                nom: inputs.propNom.value,
                contact: inputs.propContact.value
            });

            const selectedIndex = inputs.propertySelector.value;
            const currentPropId = (isNew || !inputs.propertySelector.value) ? window.crypto.randomUUID() : currentProperties[selectedIndex].id;
            
            const propertyData = {
                locataire: inputs.locNom.value,
                email: inputs.locEmail.value,
                adresse: inputs.locAdresse.value,
                loyer_hc: parseFloat(inputs.loyer.value) || 0,
                charges: parseFloat(inputs.charges.value) || 0
            };
            
            try {
                const docRef = doc(getUserPropertiesCollectionRef(), currentPropId);
                await setDoc(docRef, propertyData, { merge: false });
                
                inputs.actionMessage.textContent = "Bien sauvegardé avec succès !";
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du bien:", error);
                inputs.actionMessage.textContent = "Erreur de sauvegarde.";
            }
        }

        async function deleteSelectedProperty() {
            if (!isAuthReady || currentProperties.length === 0) return;
            
            inputs.actionMessage.textContent = "Suppression en cours...";

            const selectedIndex = inputs.propertySelector.value;
            const propertyToDelete = currentProperties[selectedIndex];
            
            if (!propertyToDelete || !propertyToDelete.id) {
                inputs.actionMessage.textContent = "Erreur: Bien introuvable.";
                return;
            }

            try {
                const docRef = doc(getUserPropertiesCollectionRef(), propertyToDelete.id);
                await deleteDoc(docRef);
                inputs.actionMessage.textContent = "Bien supprimé !";
            } catch (error) {
                console.error("Erreur lors de la suppression du bien:", error);
                inputs.actionMessage.textContent = "Erreur lors de la suppression.";
            }
        }

        // **********************************************************
        // ** 3. LOGIQUE D'INTERFACE ET DE PRÉVISUALISATION        **
        // **********************************************************

        // Fonction de navigation entre les onglets
        function showTab(tabName) {
            inputs.tabQuittance.classList.add('hidden');
            inputs.tabSuivi.classList.add('hidden');
            inputs.tabQuittanceBtn.classList.remove('active');
            inputs.tabSuiviBtn.classList.remove('active');
            
            if (tabName === 'quittance') {
                inputs.tabQuittance.classList.remove('hidden');
                inputs.tabQuittanceBtn.classList.add('active');
            } else if (tabName === 'suivi') {
                inputs.tabSuivi.classList.remove('hidden');
                inputs.tabSuiviBtn.classList.add('active');
                updateSuiviPanel(); // Met à jour le suivi quand l'onglet est activé
            }
        }

        // Fonction pour remplir le menu déroulant
        function populatePropertySelector() {
            inputs.propertySelector.innerHTML = '';
            
            if (currentProperties.length === 0) {
                 const option = document.createElement('option');
                 option.value = '';
                 option.textContent = "--- Aucune propriété ---";
                 inputs.propertySelector.appendChild(option);
                 inputs.deleteBtn.disabled = true;
                 return;
            }

            currentProperties.forEach((prop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${prop.locataire} - ${prop.adresse}`; 
                inputs.propertySelector.appendChild(option);
            });
            inputs.deleteBtn.disabled = false;
        }

        // Fonction pour charger les données d'un bien sélectionné
        function loadPropertyData(selectedIndex) {
            const index = parseInt(selectedIndex);
            const prop = currentProperties[index];

            if (prop) {
                inputs.locNom.value = prop.locataire || '';
                inputs.locEmail.value = prop.email || '';
                inputs.locAdresse.value = prop.adresse || '';
                inputs.loyer.value = prop.loyer_hc ? prop.loyer_hc.toFixed(2) : '0.00';
                inputs.charges.value = prop.charges ? prop.charges.toFixed(2) : '0.00';
            }
            updatePreview();
        }
        
        // Vider les champs pour l'ajout d'un nouveau bien
        function clearForm() {
            inputs.locNom.value = "Nouveau Locataire";
            inputs.locEmail.value = "";
            inputs.locAdresse.value = "Nouvelle Adresse";
            inputs.loyer.value = "0.00";
            inputs.charges.value = "0.00";
            inputs.propertySelector.value = ''; 
            inputs.deleteBtn.disabled = true;
            inputs.actionMessage.textContent = "Saisissez les données et cliquez sur 'Sauvegarder'.";
            updatePreview();
        }

        // Fonction de conversion de nombre à toutes lettres (Français)
        function numberToWordsFrench(n) {
            if (n === 0) return 'Zéro Euro';
            const s = n.toString();
            let part = s.split('.');
            let euros = parseInt(part[0]);
            let centimes = part.length > 1 ? parseInt(part[1].padEnd(2, '0')) : 0;

            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', 'dix', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante-dix', 'quatre-vingt', 'quatre-vingt-dix'];

            function convert(num) {
                if (num < 10) return units[num];
                if (num < 20) return teens[num - 10];
                if (num < 70) {
                    let ten = Math.floor(num / 10);
                    let unit = num % 10;
                    if (ten === 6 && unit <= 9) { return 'soixante-' + convert(num - 60); }
                    return tens[ten] + (unit > 0 ? (unit === 1 && ten === 7 || ten === 9 ? '-et-' : '-') + units[unit] : '');
                }
                if (num < 80) { return 'soixante-' + convert(num - 60); }
                if (num < 90) { return 'quatre-vingt' + (num > 80 ? ('-' + convert(num - 80)) : ''); }
                if (num < 100) { return 'quatre-vingt-dix-' + convert(num - 90); }
                if (num < 200) { return 'cent' + (num > 100 ? ' ' + convert(num - 100) : ''); }
                if (num < 1000) {
                   let cent = Math.floor(num / 100);
                   let reste = num % 100;
                   let res = units[cent] + (cent > 1 && reste === 0 ? ' cents' : ' cent');
                   return res + (reste > 0 ? ' ' + convert(reste) : '');
                }
                if (num < 1000000) {
                    let mille = Math.floor(num / 1000);
                    let reste = num % 1000;
                    let res = (mille > 1 ? convert(mille) + ' mille' : 'mille');
                    return res + (reste > 0 ? ' ' + convert(reste) : '');
                }
                return '';
            }
            
            let euroText = convert(euros).trim() + (euros > 1 ? ' Euros' : ' Euro');
            let centimeText = centimes > 0 ? (centimes > 1 ? ' et ' + convert(centimes) + ' centimes' : ' et un centime') : '';
            let result = euroText + centimeText;
            return result.charAt(0).toUpperCase() + result.slice(1);
        }
        
        // Fonction principale de mise à jour de l'aperçu (Quittance)
        function updatePreview() {
            const loyer = parseFloat(inputs.loyer.value) || 0;
            const charges = parseFloat(inputs.charges.value) || 0;
            const total = loyer + charges;
            
            const periodeValue = inputs.periode.value;
            const [year, month] = periodeValue.split('-');
            const startDate = `01-${month}-${year}`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${lastDay}-${month}-${year}`;

            previews.propNom.textContent = inputs.propNom.value;
            previews.propContact.textContent = inputs.propContact.value;
            previews.locNom.textContent = inputs.locNom.value;
            previews.locEmail.textContent = inputs.locEmail.value; 
            previews.locAdresse.textContent = inputs.locAdresse.value;
            previews.periode.textContent = `du ${startDate} au ${endDate}`;
            
            previews.propNomText.textContent = inputs.propNom.value;
            previews.locAdresseText.textContent = inputs.locAdresse.value;
            previews.locNomText.textContent = inputs.locNom.value;
            
            previews.loyer.textContent = `${loyer.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            previews.charges.textContent = `${charges.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            previews.total.textContent = `${total.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' })}`;
            previews.totalText.textContent = numberToWordsFrench(total);

            const dateEmissionValue = inputs.dateEmission.value;
            if(dateEmissionValue) {
                const [y, m, d] = dateEmissionValue.split('-');
                previews.dateEmission.textContent = `${d}-${m}-${y}`;
            }

            previews.signature.textContent = inputs.propNom.value;
            
            updateChart(loyer, charges);
        }
        
        // Initialisation du graphique Chart.js (Quittance)
        function initChart() {
            const ctx = document.getElementById('repartitionChart').getContext('2d');
            repartitionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Loyer', 'Charges'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#10b981', '#f5a623'], 
                        borderColor: '#ffffff',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (context.parsed !== null) {
                                        label += ': ' + context.parsed.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Mise à jour du graphique (Quittance)
        function updateChart(loyer, charges) {
            if (repartitionChart) {
                repartitionChart.data.datasets[0].data = [loyer, charges];
                repartitionChart.update();
            }
        }

        // NOUVEAU: Logique pour le tableau de bord de suivi
        function updateSuiviPanel() {
            // 1. Calculs Annuels
            const totalLoyerAnnuel = monthlyData.reduce((sum, item) => sum + item.loyer, 0);
            const totalDepensesAnnuel = monthlyData.reduce((sum, item) => sum + item.total_depenses, 0);
            const beneficeNetAnnuel = totalLoyerAnnuel - totalDepensesAnnuel;
            const rentabilite = totalLoyerAnnuel > 0 ? (beneficeNetAnnuel / totalLoyerAnnuel) * 100 : 0;
            
            const formatCurrency = (value) => value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            
            // 2. Affichage des Totaux Annuels
            previews.annualRent.textContent = formatCurrency(totalLoyerAnnuel);
            previews.annualExpenses.textContent = formatCurrency(totalDepensesAnnuel);
            previews.annualNet.textContent = formatCurrency(beneficeNetAnnuel);
            previews.annualNet.classList.toggle('text-red-600', beneficeNetAnnuel < 0);
            previews.annualNet.classList.toggle('text-green-900', beneficeNetAnnuel >= 0);
            previews.annualProfitability.textContent = `${rentabilite.toFixed(2)} %`;

            // 3. Détail Mensuel
            let detailHTML = '';
            monthlyData.forEach(item => {
                const rowClass = item.benefice_net < 0 ? 'bg-red-50' : (item.benefice_net > 0 ? 'bg-green-50' : '');
                detailHTML += `
                    <tr class="border-b ${rowClass}">
                        <td class="p-2">${item.mois}</td>
                        <td class="p-2 text-right">${formatCurrency(item.loyer)}</td>
                        <td class="p-2 text-right">${formatCurrency(item.total_depenses)}</td>
                        <td class="p-2 text-right font-bold">${formatCurrency(item.benefice_net)}</td>
                    </tr>
                `;
            });
            previews.monthlyDetail.innerHTML = detailHTML;
            
            // 4. Mise à jour du graphique de Bénéfice Net
            updateNetBenefitChart(monthlyData.map(item => item.mois), monthlyData.map(item => item.benefice_net));
        }

        // NOUVEAU: Initialisation et mise à jour du graphique de Bénéfice Net
        function initNetBenefitChart() {
            const ctx = document.getElementById('netBenefitChart').getContext('2d');
            netBenefitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(item => item.mois),
                    datasets: [{
                        label: 'Bénéfice Net Mensuel (€)',
                        data: monthlyData.map(item => item.benefice_net),
                        backgroundColor: (context) => {
                            const value = context.parsed.y;
                            return value >= 0 ? '#10b981' : '#ef4444'; // Vert si positif, Rouge si négatif
                        },
                        borderColor: '#ffffff',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Bénéfice Net (€)' }
                        },
                        x: {
                            title: { display: true, text: 'Mois' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        label += ': ' + context.parsed.y.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateNetBenefitChart(labels, data) {
            if (netBenefitChart) {
                netBenefitChart.data.labels = labels;
                netBenefitChart.data.datasets[0].data = data;
                netBenefitChart.update();
            }
        }


        // 4. Initialisation et écouteurs finaux
        
        function initializeApp() {
            // Initialisation de la date d'émission à la date du jour
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            inputs.dateEmission.value = `${yyyy}-${mm}-${dd}`;

            // Écouteurs pour la mise à jour des champs (Locataire/Loyer/Charges)
            const manualInputs = [inputs.periode, inputs.dateEmission, inputs.loyer, inputs.charges, inputs.locNom, inputs.locEmail, inputs.locAdresse, inputs.propNom, inputs.propContact];
            manualInputs.forEach(input => {
                input.addEventListener('keyup', updatePreview);
                input.addEventListener('change', updatePreview);
            });
            
            // Événements du sélecteur et des boutons de gestion
            inputs.propertySelector.addEventListener('change', (e) => loadPropertyData(e.target.value));
            inputs.saveBtn.addEventListener('click', () => {
                const isNew = !inputs.propertySelector.value || currentProperties.length === 0; 
                savePropertyData(isNew);
            });
            inputs.deleteBtn.addEventListener('click', deleteSelectedProperty);
            inputs.addNewBtn.addEventListener('click', clearForm);

            // Boutons de Quittance
            document.getElementById('print-btn').addEventListener('click', () => { window.print(); });
            document.getElementById('email-btn').addEventListener('click', sendEmail);
            
            // NOUVEAU: Gestion des Onglets
            inputs.tabQuittanceBtn.addEventListener('click', () => showTab('quittance'));
            inputs.tabSuiviBtn.addEventListener('click', () => showTab('suivi'));
            
            initChart(); // Graphique Quittance
            initNetBenefitChart(); // Graphique Suivi
            updatePreview(); 
            updateSuiviPanel();
        }

        document.addEventListener('DOMContentLoaded', () => {
             initializeFirebase();
             initializeApp();
        });
    </script>
</body>
</html>
